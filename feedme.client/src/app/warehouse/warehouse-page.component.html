<div class="warehouse-page">
  <aside class="warehouse-page__sidebar">
    <div class="warehouse-page__brand">Rest.Name</div>

    <nav class="warehouse-page__primary-nav">
      <span class="warehouse-page__primary-link warehouse-page__primary-link--active">Склад</span>
      <a class="warehouse-page__primary-link" href="javascript:void(0)">Заказы</a>
      <a class="warehouse-page__primary-link" href="javascript:void(0)">Касса</a>
      <a class="warehouse-page__primary-link" href="javascript:void(0)">Аналитика</a>
      <a class="warehouse-page__primary-link" href="javascript:void(0)">Настройки</a>
    </nav>

    <div class="warehouse-page__divider" aria-hidden="true"></div>

    <section class="warehouse-page__locations">
      <h2 class="warehouse-page__locations-title">Склады</h2>
      <span class="warehouse-page__location warehouse-page__location--active">Главный склад</span>
      <a class="warehouse-page__location" href="javascript:void(0)">Кухня</a>
      <a class="warehouse-page__location" href="javascript:void(0)">Бар</a>
      <a class="warehouse-page__location" href="javascript:void(0)">Холодильник</a>
    </section>
  </aside>

  <main class="warehouse-page__content">
    <section class="warehouse-page__overview" aria-label="Обзор склада">
      <div class="warehouse-page__header">
        <div class="warehouse-page__header-context">
          <h1 class="warehouse-page__title">Поставки</h1>
          <p class="warehouse-page__subtitle">Контролируйте движение товаров и запасы</p>
        </div>
        <label class="warehouse-page__warehouse-picker">
          <span class="warehouse-page__warehouse-picker-label">Склад</span>
          <div class="warehouse-page__warehouse-picker-control">
            <select
              #activeWarehouse
              class="warehouse-page__warehouse-select"
              [value]="selectedWarehouse()"
              (change)="selectWarehouse(activeWarehouse.value)"
              aria-label="Выбор активного склада"
            >
              <option *ngFor="let warehouseName of warehouses()" [value]="warehouseName">
                {{ warehouseName }}
              </option>
            </select>
          </div>
        </label>
      </div>

      <section
        *ngIf="overviewMetrics() as snapshot"
        class="warehouse-page__snapshot"
        aria-label="Ключевые показатели склада"
      >
        <article class="warehouse-page__metric-card" aria-live="polite">
          <p class="warehouse-page__metric-label">Поставок за 7 дней</p>
          <p class="warehouse-page__metric-value">{{ snapshot.suppliesLastWeek }}</p>
        </article>

        <article class="warehouse-page__metric-card" aria-live="polite">
          <p class="warehouse-page__metric-label">Сумма закупок / 7 дн.</p>
          <p class="warehouse-page__metric-value warehouse-page__metric-value--currency">
            {{ formatCurrency(snapshot.purchaseAmountLastWeek) }}
          </p>
        </article>

        <article class="warehouse-page__metric-card" aria-live="polite">
          <p class="warehouse-page__metric-label">Позиций на складе</p>
          <p class="warehouse-page__metric-value">{{ snapshot.positions }}</p>
        </article>

        <article class="warehouse-page__metric-card warehouse-page__metric-card--expired" aria-live="polite">
          <p class="warehouse-page__metric-label">Просрочено</p>
          <p class="warehouse-page__metric-value">
            <span class="warehouse-page__metric-badge">{{ snapshot.expired }}</span>
          </p>
        </article>
      </section>

      <app-supply-controls
        [activeTab]="activeTab()"
        (activeTabChange)="selectTab($event)"

      ></app-supply-controls>
    </section>

    <section *ngIf="activeTab() === 'supplies'" class="warehouse-page__tab-panel">
        <div class="card warehouse-page__filters-card">
          <form
            class="warehouse-page__filters card__content p-4 flex flex-wrap items-center gap-3"
            (submit)="$event.preventDefault()"
          >
            <div class="warehouse-page__filters-control warehouse-page__filters-control--select">
              <label class="warehouse-page__filters-field">
                <span class="warehouse-page__filters-label">Статус</span>
                <select
                  #statusSelect
                  class="select"
                  [value]="status()"
                  (change)="updateStatus(statusSelect.value)"
                  aria-label="Фильтр по статусу"
                >
                  <option value="">Все статусы</option>
                  <option *ngFor="let statusOption of statuses" [value]="statusOption">
                    {{ statusOption | statusBadgeLabel }}
                  </option>
                </select>
              </label>
            </div>
            <div class="warehouse-page__filters-control warehouse-page__filters-control--select">
              <label class="warehouse-page__filters-field">
                <span class="warehouse-page__filters-label">Поставщик</span>
                <select
                  #supplierSelect
                  class="select"
                  [value]="supplier()"
                  (change)="updateSupplier(supplierSelect.value)"
                  aria-label="Фильтр по поставщику"
                >
                  <option value="">Все поставщики</option>
                  <option *ngFor="let supplierName of suppliers()" [value]="supplierName">
                    {{ supplierName }}
                  </option>
                </select>
              </label>
            </div>
            <div class="warehouse-page__filters-control warehouse-page__filters-control--date w-[160px]">
              <label class="warehouse-page__filters-field">
                <span class="warehouse-page__filters-label">Приход от</span>
                <input
                  #dateFromInput
                  class="input"
                  type="date"
                  aria-label="Дата прихода от"
                  [value]="dateFrom()"
                  (change)="updateDateFrom(dateFromInput.value)"
                />
              </label>
            </div>
            <div class="warehouse-page__filters-control warehouse-page__filters-control--date w-[160px]">
              <label class="warehouse-page__filters-field">
                <span class="warehouse-page__filters-label">Приход до</span>
                <input
                  #dateToInput
                  class="input"
                  type="date"
                  aria-label="Дата прихода до"
                  [value]="dateTo()"
                  (change)="updateDateTo(dateToInput.value)"
                />
              </label>
            </div>
            <button type="button" class="btn btn-outline" (click)="clearFilters()">Сброс</button>
            <button type="button" class="btn btn-brand-outline">Импорт</button>
            <button type="button" class="btn btn-secondary">Экспорт</button>
            <button type="button" class="btn ml-auto" (click)="openCreateDialog()">+ Новая поставка</button>
          </form>
        </div>

        <section class="warehouse-page__bulk" *ngIf="hasSelection()" aria-live="polite">
          <span class="warehouse-page__bulk-count">Выбрано: {{ checkedIds().length }}</span>
          <div class="warehouse-page__bulk-actions">
            <button type="button" class="btn btn-outline btn-sm">Списать</button>
            <button type="button" class="btn btn-outline btn-sm">Переместить</button>
            <button type="button" class="btn btn-outline btn-sm">Печать</button>
            <button type="button" class="btn btn-danger btn-sm" (click)="openDeleteDialogForSelection()">Удалить</button>
          </div>
        </section>

        <section class="warehouse-page__table-card">
          <header class="warehouse-page__table-header">Последние поставки</header>
          <div class="warehouse-page__table-wrapper">
            <table class="warehouse-page__table tbl-compact">
              <thead
                class="sticky top-0 bg-background/90 backdrop-blur border-b shadow-[inset_0_-1px_0_0_var(--border)]"
              >
                <tr>
                  <th
                    scope="col"
                    class="warehouse-page__cell warehouse-page__cell--checkbox text-sm font-medium w-[40px]"
                  >
                    <input
                      type="checkbox"
                      [checked]="allFilteredChecked()"
                      (change)="toggleAllFromEvent($event)"
                      aria-label="Выбрать все"
                    />
                  </th>
                  <th
                    scope="col"
                    class="warehouse-page__cell text-sm font-medium font-mono text-xs"
                    title="Номер приходного документа"
                  >
                    № док.
                  </th>
                  <th
                    scope="col"
                    class="warehouse-page__cell warehouse-page__cell--center text-sm font-medium text-center"
                  >
                    Дата прихода
                  </th>
                  <th scope="col" class="warehouse-page__cell text-sm font-medium">Склад</th>
                  <th scope="col" class="warehouse-page__cell text-sm font-medium">Ответственный</th>
                  <th scope="col" class="warehouse-page__cell text-sm font-medium font-mono text-xs">
                    SKU
                  </th>
                  <th scope="col" class="warehouse-page__cell text-sm font-medium">Название</th>
                  <th
                    scope="col"
                    class="warehouse-page__cell warehouse-page__cell--numeric text-sm font-medium text-right"
                    title="Количество в базовой ед. изм."
                  >
                    Кол-во
                  </th>
                  <th
                    scope="col"
                    class="warehouse-page__cell warehouse-page__cell--center text-sm font-medium text-center"
                    title="Дата, после которой товар списывается"
                  >
                    Срок годности
                  </th>
                  <th scope="col" class="warehouse-page__cell text-sm font-medium">Поставщик</th>
                  <th
                    scope="col"
                    class="warehouse-page__cell warehouse-page__cell--status text-sm font-medium"
                  >
                    Статус
                  </th>
                  <th
                    scope="col"
                    class="warehouse-page__cell warehouse-page__cell--icon text-sm font-medium w-[44px]"
                    aria-hidden="true"
                  ></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let row of filteredRows(); trackBy: trackByRow"
                  class="warehouse-page__row hover:bg-muted/40 odd:bg-muted/10 h-11 align-middle"
                  (dblclick)="openDrawer(row)"
                >
                  <td class="warehouse-page__cell warehouse-page__cell--checkbox w-[40px]">
                    <input
                      type="checkbox"
                      [checked]="checkedIds().includes(row.id)"
                      (change)="handleRowCheckbox(row.id, $event)"
                      [attr.aria-label]="'Строка ' + row.docNo"
                    />
                  </td>
                  <td class="warehouse-page__cell font-mono text-xs">{{ row.docNo }}</td>
                  <td class="warehouse-page__cell warehouse-page__cell--center text-center">{{ row.arrivalDate | date: 'dd.MM.yyyy' }}</td>
                  <td class="warehouse-page__cell">{{ row.warehouse }}</td>
                  <td class="warehouse-page__cell">{{ row.responsible }}</td>
                  <td class="warehouse-page__cell font-mono text-xs">{{ row.sku }}</td>
                  <td class="warehouse-page__cell warehouse-page__cell--name">
                    <button
                      type="button"
                      class="warehouse-page__product-name font-medium truncate cursor-default"
                      (click)="openDrawer(row)"
                      [attr.title]="row.name"
                    >
                      {{ row.name }}
                    </button>
                  </td>
                  <td class="warehouse-page__cell warehouse-page__cell--numeric text-right">
                    {{ row.qty | number: '1.0-3' }} {{ row.unit }}
                  </td>
                  <td class="warehouse-page__cell warehouse-page__cell--center text-center">{{ row.expiry | date: 'dd.MM.yyyy' }}</td>
                  <td class="warehouse-page__cell warehouse-page__cell--supplier" [attr.title]="row.supplier">
                    <span class="truncate">{{ row.supplier }}</span>
                  </td>
                  <td class="warehouse-page__cell warehouse-page__cell--status min-w-[112px]">
                    <span
                      class="badge min-w-[112px] justify-center"
                      [ngClass]="row.status | statusBadgeClass"
                    >
                      {{ row.status | statusBadgeLabel }}
                    </span>
                  </td>
                  <td class="warehouse-page__cell warehouse-page__cell--icon">
                    <div class="warehouse-page__row-menu">
                      <button
                        type="button"
                        class="warehouse-page__row-menu-trigger"
                        (click)="toggleRowMenu(row.id, $event)"
                        aria-haspopup="menu"
                        aria-label="Действия строки"
                      >
                        ⋯
                      </button>
                      <div
                        class="warehouse-page__row-menu-panel"
                        *ngIf="menuRowId() === row.id"
                        role="menu"
                        (click)="$event.stopPropagation()"
                      >
                        <button type="button" role="menuitem" (click)="openDrawer(row)">Открыть</button>
                        <button type="button" role="menuitem" (click)="startEdit(row)">Редактировать</button>
                        <button type="button" role="menuitem" (click)="openDeleteDialogForRow(row)">Удалить</button>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="filteredRows().length === 0">
                  <td class="warehouse-page__cell warehouse-page__empty-row" colspan="12">
                    Нет поставок по текущим фильтрам
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <footer class="warehouse-page__table-footer">
            <span>
              Показано {{ filteredRows().length }} из {{ rows().length }}.
              Итог по сумме: {{ formatCurrency(totalSum()) }}
            </span>
            <div class="warehouse-page__pagination">
              <button type="button" class="btn btn-outline btn-sm">Назад</button>
              <button type="button" class="btn btn-outline btn-sm">Далее</button>
            </div>
          </footer>
        </section>
      </section>

      <section *ngIf="activeTab() === 'stock'" class="warehouse-page__empty">
        <app-empty title="Остатки" subtitle="Выберите склад и примените фильтры"></app-empty>
      </section>
      <section *ngIf="activeTab() === 'catalog'" class="warehouse-page__tab-panel">
        <app-catalog></app-catalog>
      </section>
      <section *ngIf="activeTab() === 'inventory'" class="warehouse-page__empty">
        <app-empty title="Инвентаризация" subtitle="Создайте обход или запустите экспресс-пересчёт"></app-empty>
      </section>
  </main>

  <aside class="warehouse-page__drawer" *ngIf="drawerOpen() && selectedRow() as row">
    <section class="warehouse-page__drawer-content">
      <header class="warehouse-page__drawer-header">
        <div>
          <div class="warehouse-page__drawer-sku">Документ {{ row.docNo }}</div>
          <div class="warehouse-page__drawer-title">{{ row.name }}</div>
          <div class="warehouse-page__drawer-meta">SKU {{ row.sku }}</div>
        </div>
        <span class="badge" [ngClass]="row.status | statusBadgeClass">
          {{ row.status | statusBadgeLabel }}
        </span>
      </header>
      <div class="warehouse-page__drawer-grid">
        <app-field label="Склад" [value]="row.warehouse"></app-field>
        <app-field label="Ответственный" [value]="row.responsible"></app-field>
        <app-field label="Поставщик" [value]="row.supplier"></app-field>
        <app-field label="Категория" [value]="row.category"></app-field>
        <app-field label="Кол-во" [value]="row.qty + ' ' + row.unit"></app-field>
        <app-field label="Цена" [value]="formatCurrency(row.price)"></app-field>
        <app-field label="Сумма" [value]="formatCurrency(rowTotal(row))"></app-field>
        <app-field label="Дата прихода" [value]="(row.arrivalDate | date: 'dd.MM.yyyy') ?? row.arrivalDate"></app-field>
        <app-field label="Срок годности" [value]="(row.expiry | date: 'dd.MM.yyyy') ?? row.expiry"></app-field>
      </div>
      <footer class="warehouse-page__drawer-actions">
        <button type="button" class="btn btn-outline btn-sm">Списать</button>
        <button type="button" class="btn btn-outline btn-sm">Переместить</button>
        <button type="button" class="btn btn-sm">Печать ярлыков</button>
        <button type="button" class="btn btn-outline btn-sm" (click)="startEdit(row)">Редактировать</button>
        <button type="button" class="btn btn-danger btn-sm" (click)="openDeleteDialogForRow(row)">Удалить</button>
        <button type="button" class="btn btn-ghost btn-sm" (click)="closeDrawer()">Закрыть</button>
      </footer>
    </section>
  </aside>

  <div class="warehouse-page__dialog-backdrop" *ngIf="createDialogOpen()">
    <app-create-supply-dialog
      (cancel)="closeCreateDialog()"
      (create)="handleCreateSupply($event)"
    ></app-create-supply-dialog>
  </div>

  <div class="warehouse-page__dialog-backdrop" *ngIf="editDialogOpen()">
    <section class="warehouse-page__dialog" role="dialog" aria-modal="true" aria-labelledby="edit-supply-title">
      <header class="warehouse-page__dialog-header" id="edit-supply-title">
        {{ editingRowId() ? 'Редактирование поставки' : 'Новая поставка' }}
      </header>
      <form class="warehouse-page__dialog-form" [formGroup]="editForm" (ngSubmit)="submitEdit()">

        <div class="warehouse-page__dialog-grid">
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">№ документа</span>
            <input class="input" formControlName="docNo" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Дата прихода</span>
            <input class="input" type="date" formControlName="arrivalDate" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Склад</span>
            <input class="input" formControlName="warehouse" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Ответственный</span>
            <input class="input" formControlName="responsible" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Поставщик</span>
            <input class="input" formControlName="supplier" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">SKU</span>
            <input class="input" formControlName="sku" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Название</span>
            <input class="input" formControlName="name" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Категория</span>
            <input class="input" formControlName="category" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Кол-во</span>
            <input class="input" type="number" step="0.001" min="0" formControlName="qty" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Единица измерения</span>
            <input class="input" formControlName="unit" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Цена</span>
            <input class="input" type="number" step="0.01" min="0" formControlName="price" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Срок годности</span>
            <input class="input" type="date" formControlName="expiry" />
            <span class="warehouse-page__field-error" *ngIf="editForm.controls.expiry.touched && editForm.controls.expiry.hasError('dateOrder')">
              Срок годности не может быть раньше даты прихода
            </span>
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Статус</span>
            <select class="select" formControlName="status">
              <option *ngFor="let statusOption of statuses" [value]="statusOption">
                {{ statusOption | statusBadgeLabel }}
              </option>
            </select>
          </label>
        </div>

        <footer class="warehouse-page__dialog-actions">
          <button type="button" class="btn btn-outline" (click)="closeEditDialog()">Отмена</button>
          <button type="submit" class="btn" [disabled]="editForm.invalid">Сохранить</button>
        </footer>
      </form>
    </section>
  </div>

  <div class="warehouse-page__dialog-backdrop" *ngIf="deleteDialogOpen()">
    <section class="warehouse-page__dialog warehouse-page__dialog--confirm" role="dialog" aria-modal="true" aria-labelledby="delete-supply-title">
      <header class="warehouse-page__dialog-header" id="delete-supply-title">Удалить поставку</header>
      <div class="warehouse-page__dialog-content">
        <ng-container *ngIf="deleteTargetIds().length === 1; else deleteMany">
          <ng-container *ngIf="getRowById(deleteTargetIds()[0]) as deletingRow">
            <p>
              Удалить поставку <strong>{{ deletingRow.docNo }}</strong> — {{ deletingRow.name }} ({{ deletingRow.sku }})?
            </p>
          </ng-container>
        </ng-container>
        <ng-template #deleteMany>
          <p>Удалить выбранные {{ deleteTargetIds().length }} поставок? Действие необратимо.</p>
        </ng-template>
      </div>
      <footer class="warehouse-page__dialog-actions">
        <button type="button" class="btn btn-outline" (click)="closeDeleteDialog()">Отмена</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">Удалить</button>
      </footer>
    </section>
  </div>
</div>
