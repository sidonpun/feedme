<div class="warehouse-page">
  <aside class="warehouse-page__sidebar">
    <div class="warehouse-page__brand">Rest.Name</div>

    <nav class="warehouse-page__primary-nav">
      <span class="warehouse-page__primary-link warehouse-page__primary-link--active">Склад</span>
      <a class="warehouse-page__primary-link" href="javascript:void(0)">Заказы</a>
      <a class="warehouse-page__primary-link" href="javascript:void(0)">Касса</a>
      <a class="warehouse-page__primary-link" href="javascript:void(0)">Аналитика</a>
      <a class="warehouse-page__primary-link" href="javascript:void(0)">Настройки</a>
    </nav>

    <div class="warehouse-page__divider" aria-hidden="true"></div>

    <section class="warehouse-page__locations">
      <h2 class="warehouse-page__locations-title">Склады</h2>
      <span class="warehouse-page__location warehouse-page__location--active">Главный склад</span>
      <a class="warehouse-page__location" href="javascript:void(0)">Кухня</a>
      <a class="warehouse-page__location" href="javascript:void(0)">Бар</a>
      <a class="warehouse-page__location" href="javascript:void(0)">Холодильник</a>
    </section>
  </aside>

  <main class="warehouse-page__content">
    <header class="warehouse-page__top-bar">
      <div class="warehouse-page__breadcrumbs">
        Главный склад / <span class="warehouse-page__breadcrumb-current">Поставки</span>
      </div>
      <div class="warehouse-page__actions">
        <button type="button" class="btn btn-ghost" (click)="focusSearch()">Найти поставку (/)</button>
      </div>
    </header>

    <section class="warehouse-page__body">
      <div class="warehouse-page__metrics">
        <app-metric title="Позиций на складе" value="1 248" hint="активные SKU"></app-metric>
        <app-metric title="Просрочено" value="2" hint="требует списания" variant="danger"></app-metric>
        <app-metric title="Скоро срок" value="7" hint="≤ 14 дней" variant="warn"></app-metric>
        <app-metric title="Ниже минимума" value="5" hint="> авто-заказ" variant="warn"></app-metric>
      </div>

      <nav class="warehouse-page__tabs" role="tablist">
        <button
          type="button"
          *ngFor="let entry of tabKeys"
          class="warehouse-page__tab"
          [class.warehouse-page__tab--active]="activeTab() === entry"
          (click)="selectTab(entry)"
          role="tab"
          [attr.aria-selected]="activeTab() === entry"
        >
          {{ tabLabels[entry] }}
        </button>
      </nav>

      <section *ngIf="activeTab() === 'supplies'" class="warehouse-page__tab-panel">
        <form class="warehouse-page__filters" (submit)="$event.preventDefault()">
          <label class="warehouse-page__filter">
            <span class="warehouse-page__filter-label">Поиск</span>
            <input
              #searchInput
              data-testid="supplies-search"
              class="input"
              type="search"
              placeholder="№ документа, название или SKU (/)"
              [value]="query()"
              (input)="handleSearchChange($event)"
            />
          </label>
          <label class="warehouse-page__filter">
            <span class="warehouse-page__filter-label">Статус</span>
            <select
              data-testid="supplies-status-filter"
              class="select"
              [value]="status()"
              (change)="handleStatusChange($event)"
            >
              <option value="">Все</option>
              <option value="ok">Ок</option>
              <option value="warning">Скоро срок</option>
              <option value="danger">Просрочено</option>
            </select>
          </label>
          <label class="warehouse-page__filter">
            <span class="warehouse-page__filter-label">Поставщик</span>
            <select
              data-testid="supplies-supplier-filter"
              class="select"
              [value]="supplier()"
              (change)="handleSupplierChange($event)"
            >
              <option value="">Все поставщики</option>
              <option *ngFor="let option of suppliers()" [value]="option">{{ option }}</option>
            </select>
          </label>
          <label class="warehouse-page__filter">
            <span class="warehouse-page__filter-label">Склад</span>
            <select
              data-testid="supplies-warehouse-filter"
              class="select"
              [value]="warehouse()"
              (change)="handleWarehouseChange($event)"
            >
              <option value="">Все склады</option>
              <option *ngFor="let option of warehouses()" [value]="option">{{ option }}</option>
            </select>
          </label>
          <label class="warehouse-page__filter">
            <span class="warehouse-page__filter-label">Дата от</span>
            <input
              data-testid="supplies-date-from"
              class="input"
              type="date"
              [value]="dateFrom()"
              (change)="handleDateFromChange($event)"
            />
          </label>
          <label class="warehouse-page__filter">
            <span class="warehouse-page__filter-label">Дата до</span>
            <input
              data-testid="supplies-date-to"
              class="input"
              type="date"
              [value]="dateTo()"
              (change)="handleDateToChange($event)"
            />
          </label>
          <div class="warehouse-page__filters-actions">
            <button type="button" class="btn btn-outline" (click)="clearFilters()">Сброс</button>
            <button type="button" class="btn btn-secondary" (click)="exportFiltered()">Экспорт</button>
          </div>
        </form>

        <section class="warehouse-page__bulk" aria-live="polite">
          <ng-container *ngIf="hasSelection(); else selectionHint">
            <span class="warehouse-page__bulk-count">Выбрано: {{ checkedIds().length }}</span>
            <div class="warehouse-page__bulk-actions">
              <button type="button" class="btn btn-outline btn-sm" (click)="handleMassWriteOff()">Списать</button>
              <button type="button" class="btn btn-outline btn-sm" (click)="handleMassMove()">Переместить</button>
              <button type="button" class="btn btn-outline btn-sm" (click)="handleMassPrint()">Печать</button>
              <button
                type="button"
                data-testid="bulk-delete"
                class="btn btn-danger btn-sm"
                (click)="openBulkDelete()"
              >
                Удалить
              </button>
            </div>
          </ng-container>
          <ng-template #selectionHint>
            <span class="warehouse-page__bulk-hint">Подсказка: выделите строки для массовых действий</span>
          </ng-template>
        </section>

        <section class="warehouse-page__table-card">
          <header class="warehouse-page__table-header">Поставки</header>
          <div class="warehouse-page__table-wrapper">
            <table class="warehouse-page__table">
              <thead>
                <tr>
                  <th class="warehouse-page__cell warehouse-page__cell--checkbox">
                    <input
                      data-testid="supplies-header-checkbox"
                      type="checkbox"
                      [checked]="allRowsChecked()"
                      (change)="toggleAllFromEvent($event)"
                      aria-label="Выбрать все"
                    />
                  </th>
                  <th class="warehouse-page__cell warehouse-page__cell--mono">№ док.</th>
                  <th class="warehouse-page__cell warehouse-page__cell--center">Дата прихода</th>
                  <th class="warehouse-page__cell">Склад</th>
                  <th class="warehouse-page__cell">Ответственный</th>
                  <th class="warehouse-page__cell warehouse-page__cell--mono">SKU</th>
                  <th class="warehouse-page__cell">Название</th>
                  <th class="warehouse-page__cell">Категория</th>
                  <th class="warehouse-page__cell warehouse-page__cell--numeric">Кол-во</th>
                  <th class="warehouse-page__cell warehouse-page__cell--numeric">Цена</th>
                  <th class="warehouse-page__cell warehouse-page__cell--numeric">Сумма</th>
                  <th class="warehouse-page__cell warehouse-page__cell--center">Срок годн.</th>
                  <th class="warehouse-page__cell">Поставщик</th>
                  <th class="warehouse-page__cell">Статус</th>
                  <th class="warehouse-page__cell warehouse-page__cell--icon" aria-label="Действия"></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let row of filteredRows(); trackBy: trackByRow"
                  (dblclick)="handleRowDoubleClick(row)"
                >
                  <td class="warehouse-page__cell warehouse-page__cell--checkbox">
                    <input
                      data-testid="supplies-row-checkbox"
                      type="checkbox"
                      [checked]="isRowChecked(row.id)"
                      (click)="$event.stopPropagation()"
                      (change)="handleRowCheckboxChange(row, $event)"
                      [attr.aria-label]="'Строка ' + row.docNo"
                    />
                  </td>
                  <td class="warehouse-page__cell warehouse-page__cell--mono">{{ row.docNo }}</td>
                  <td class="warehouse-page__cell warehouse-page__cell--center">{{ row.arrivalDate }}</td>
                  <td class="warehouse-page__cell">{{ row.warehouse }}</td>
                  <td class="warehouse-page__cell">{{ row.responsible }}</td>
                  <td class="warehouse-page__cell warehouse-page__cell--mono">{{ row.sku }}</td>
                  <td class="warehouse-page__cell">{{ row.name }}</td>
                  <td class="warehouse-page__cell">{{ row.category }}</td>
                  <td class="warehouse-page__cell warehouse-page__cell--numeric">{{ row.qty }} {{ row.unit }}</td>
                  <td class="warehouse-page__cell warehouse-page__cell--numeric">{{ row.price | rubCurrency }}</td>
                  <td
                    class="warehouse-page__cell warehouse-page__cell--numeric"
                    [attr.data-testid]="'sum-' + row.id"
                  >
                    {{ calculateRowTotal(row) | rubCurrency }}
                  </td>
                  <td class="warehouse-page__cell warehouse-page__cell--center">{{ row.expiry }}</td>
                  <td class="warehouse-page__cell">{{ row.supplier }}</td>
                  <td class="warehouse-page__cell">
                    <span [ngClass]="badgeClass(row.status)">{{ statusLabel(row.status) }}</span>
                  </td>
                  <td class="warehouse-page__cell warehouse-page__cell--icon">
                    <div class="row-menu" (click)="$event.stopPropagation()">
                      <button
                        type="button"
                        class="row-menu__trigger"
                        data-testid="row-menu-{{ row.id }}"
                        aria-haspopup="true"
                        [attr.aria-expanded]="openedMenuId() === row.id"
                        (click)="toggleRowMenu(row.id, $event)"
                      >
                        ⋯
                      </button>
                      <div
                        *ngIf="openedMenuId() === row.id"
                        class="row-menu__popover"
                        (keydown.escape)="closeRowMenu()"
                      >
                        <button type="button" (click)="handleRowMenuAction(row, 'open', $event)">Открыть</button>
                        <button type="button" (click)="handleRowMenuAction(row, 'edit', $event)">Редактировать</button>
                        <button
                          type="button"
                          class="row-menu__danger"
                          [attr.data-testid]="'row-menu-delete-' + row.id"
                          (click)="handleRowMenuAction(row, 'delete', $event)"
                        >
                          Удалить
                        </button>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <footer class="warehouse-page__table-footer">
            <span data-testid="supplies-summary">
              Показано {{ filteredRows().length }} из {{ rows().length }}. Итог по сумме:
              {{ totalSum() | rubCurrency }}
            </span>
            <div class="warehouse-page__pagination">
              <button type="button" class="btn btn-outline btn-sm" disabled>Назад</button>
              <button type="button" class="btn btn-outline btn-sm" disabled>Далее</button>
            </div>
          </footer>
        </section>
      </section>

      <section *ngIf="activeTab() === 'stock'" class="warehouse-page__empty">
        <app-empty title="Остатки" subtitle="Выберите склад и примените фильтры"></app-empty>
      </section>
      <section *ngIf="activeTab() === 'catalog'" class="warehouse-page__empty">
        <app-empty title="Каталог" subtitle="Импортируйте CSV или создайте первую позицию"></app-empty>
      </section>
      <section *ngIf="activeTab() === 'inventory'" class="warehouse-page__empty">
        <app-empty title="Инвентаризация" subtitle="Создайте обход или запустите экспресс-пересчёт"></app-empty>
      </section>
    </section>
  </main>

  <aside class="warehouse-page__drawer" *ngIf="drawerRow() as row">
    <section class="warehouse-page__drawer-content">
      <header class="warehouse-page__drawer-header">
        <div>
          <div class="warehouse-page__drawer-doc">№ {{ row.docNo }}</div>
          <div class="warehouse-page__drawer-title">{{ row.name }}</div>
          <div class="warehouse-page__drawer-meta">Поступление {{ row.arrivalDate }} • {{ row.warehouse }}</div>
        </div>
        <span [ngClass]="badgeClass(row.status)">{{ statusLabel(row.status) }}</span>
      </header>
      <div class="warehouse-page__drawer-grid">
        <app-field label="Склад" [value]="row.warehouse"></app-field>
        <app-field label="Ответственный" [value]="row.responsible"></app-field>
        <app-field label="Поставщик" [value]="row.supplier"></app-field>
        <app-field label="SKU" [value]="row.sku"></app-field>
        <app-field label="Категория" [value]="row.category"></app-field>
        <app-field label="Количество" [value]="row.qty + ' ' + row.unit"></app-field>
        <app-field label="Цена закупки" [value]="(row.price | rubCurrency)"></app-field>
        <app-field label="Сумма" [value]="(calculateRowTotal(row) | rubCurrency)"></app-field>
        <app-field label="Срок годности" [value]="row.expiry"></app-field>
      </div>
      <footer class="warehouse-page__drawer-actions">
        <button type="button" class="btn btn-outline btn-sm" (click)="handleMassWriteOff([row.id])">Списать</button>
        <button type="button" class="btn btn-outline btn-sm" (click)="handleMassMove([row.id])">Переместить</button>
        <button type="button" class="btn btn-sm" (click)="handleMassPrint([row.id])">Печать ярлыков</button>
        <button type="button" class="btn btn-ghost btn-sm" (click)="openEditDialog(row)">Редактировать</button>
        <button type="button" class="btn btn-danger btn-sm" (click)="openDeleteDialog([row.id], row.docNo + ' · ' + row.name)">Удалить</button>
        <button type="button" class="btn btn-ghost btn-sm" (click)="closeDrawer()">Закрыть</button>
      </footer>
    </section>
  </aside>

  <div class="warehouse-page__dialog-backdrop" *ngIf="editDialogVisible">
    <section class="warehouse-page__dialog" role="dialog" aria-modal="true" aria-labelledby="edit-supply-title">
      <header class="warehouse-page__dialog-header" id="edit-supply-title">Редактирование поставки</header>
      <form class="warehouse-page__dialog-form" [formGroup]="editForm" (ngSubmit)="saveEdit()">
        <div class="warehouse-page__dialog-grid">
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">№ документа</span>
            <input class="input" formControlName="docNo" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Дата прихода</span>
            <input class="input" type="date" formControlName="arrivalDate" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Склад</span>
            <input class="input" formControlName="warehouse" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Ответственный</span>
            <input class="input" formControlName="responsible" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Поставщик</span>
            <input class="input" formControlName="supplier" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">SKU</span>
            <input class="input" formControlName="sku" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Название</span>
            <input class="input" formControlName="name" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Категория</span>
            <input class="input" formControlName="category" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Количество</span>
            <input class="input" type="number" min="0" formControlName="qty" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Ед. изм.</span>
            <input class="input" formControlName="unit" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Цена</span>
            <input class="input" type="number" min="0" formControlName="price" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Срок годности</span>
            <input class="input" type="date" formControlName="expiry" />
          </label>
          <label class="warehouse-page__dialog-field">
            <span class="warehouse-page__dialog-label">Статус</span>
            <select class="select" formControlName="status">
              <option value="ok">Ок</option>
              <option value="warning">Скоро срок</option>
              <option value="danger">Просрочено</option>
            </select>
          </label>
        </div>
        <p class="warehouse-page__dialog-error" *ngIf="editForm.hasError('dateRange')">
          Дата прихода не может быть позже срока годности.
        </p>
        <footer class="warehouse-page__dialog-actions">
          <button type="button" class="btn btn-outline" (click)="closeEditDialog()">Отмена</button>
          <button type="submit" class="btn">Сохранить</button>
        </footer>
      </form>
    </section>
  </div>

  <div class="warehouse-page__dialog-backdrop" *ngIf="deleteDialog as dialog">
    <section class="warehouse-page__dialog warehouse-page__dialog--confirm" role="dialog" aria-modal="true" aria-labelledby="delete-supply-title">
      <header class="warehouse-page__dialog-header" id="delete-supply-title">Удаление поставки</header>
      <p class="warehouse-page__dialog-message">Вы уверены, что хотите удалить {{ dialog.title }}?</p>
      <footer class="warehouse-page__dialog-actions">
        <button type="button" class="btn btn-outline" (click)="closeDeleteDialog()">Отмена</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">Удалить</button>
      </footer>
    </section>
  </div>
</div>
