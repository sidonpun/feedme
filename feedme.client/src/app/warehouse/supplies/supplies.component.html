<section class="supplies">
  <header class="fm-topbar">
    <div class="crumbs"><b>Поставки</b> / Главный склад</div>
    <button class="btn btn-outline" type="button">Добавить склад</button>
  </header>

  <section class="kpis" *ngIf="kpi() as metrics">
    <div class="kpi">
      <div class="kpi__label">Поставок за 7 дней</div>
      <div class="kpi__value">{{ metrics.weekSupplies }}</div>
    </div>
    <div class="kpi">
      <div class="kpi__label">Сумма закупок / 7 дн.</div>
      <div class="kpi__value">{{ metrics.weekSpend | currency: 'RUB' }}</div>
    </div>
    <div class="kpi">
      <div class="kpi__label">Позиций на складе</div>
      <div class="kpi__value">{{ metrics.items }}</div>
    </div>
    <div class="kpi">
      <div class="kpi__label">Просрочено</div>
      <div class="kpi__value kpi__value--danger">{{ metrics.expired }}</div>
    </div>
  </section>

  <section class="filters">
    <input
      class="fm-input w-280"
      placeholder="Поиск по номеру, SKU или названию"
      [(ngModel)]="query"
    />
    <input class="fm-input w-140" type="date" [(ngModel)]="dateFrom" />
    <input class="fm-input w-140" type="date" [(ngModel)]="dateTo" />
    <button class="btn btn-outline" type="button" (click)="onReset()">Сброс</button>
    <button class="btn btn-secondary" type="button" (click)="onExport()">Экспорт</button>
    <button class="btn btn-primary" type="button" (click)="openNewSupply()">+ Новая поставка</button>
  </section>

  <div class="table-panel">
    <ng-container *ngIf="rowsReady(); else loading">
      <ng-container *ngIf="sortedRows.length > 0; else empty">
        <table class="fm-table" aria-label="Поставки">
          <thead>
            <tr>
              <th (click)="toggleSort('docNo')" [attr.aria-sort]="ariaSort('docNo')">
                № док. <span class="sort">{{ sortIcon('docNo') }}</span>
              </th>
              <th (click)="toggleSort('arrivalDate')" [attr.aria-sort]="ariaSort('arrivalDate')">
                Дата прихода <span class="sort">{{ sortIcon('arrivalDate') }}</span>
              </th>
              <th (click)="toggleSort('warehouse')" [attr.aria-sort]="ariaSort('warehouse')">
                Склад <span class="sort">{{ sortIcon('warehouse') }}</span>
              </th>
              <th (click)="toggleSort('responsible')" [attr.aria-sort]="ariaSort('responsible')">
                Ответственный <span class="sort">{{ sortIcon('responsible') }}</span>
              </th>
              <th (click)="toggleSort('sku')" [attr.aria-sort]="ariaSort('sku')">
                SKU <span class="sort">{{ sortIcon('sku') }}</span>
              </th>
              <th (click)="toggleSort('name')" [attr.aria-sort]="ariaSort('name')">
                Название <span class="sort">{{ sortIcon('name') }}</span>
              </th>
              <th class="text-right" (click)="toggleSort('qty')" [attr.aria-sort]="ariaSort('qty')">
                Кол-во <span class="sort">{{ sortIcon('qty') }}</span>
              </th>
              <th class="text-center" (click)="toggleSort('expiryDate')" [attr.aria-sort]="ariaSort('expiryDate')">
                Срок годности <span class="sort">{{ sortIcon('expiryDate') }}</span>
              </th>
              <th (click)="toggleSort('supplier')" [attr.aria-sort]="ariaSort('supplier')">
                Поставщик <span class="sort">{{ sortIcon('supplier') }}</span>
              </th>
              <th (click)="toggleSort('status')" [attr.aria-sort]="ariaSort('status')">
                Статус <span class="sort">{{ sortIcon('status') }}</span>
              </th>
            </tr>
          </thead>
          <tbody [@list]="sortedRows.length">
            <tr *ngFor="let row of sortedRows; trackBy: trackByRowId" @row>
              <td class="mono">{{ row.docNo }}</td>
              <td class="text-center">{{ row.arrivalDate | date: 'yyyy-MM-dd' }}</td>
              <td>{{ row.warehouse }}</td>
              <td>{{ row.responsible || '—' }}</td>
              <td class="mono">{{ row.sku }}</td>
              <td class="truncate" [title]="row.name">{{ row.name }}</td>
              <td class="text-right">{{ row.qty | number: '1.0-2' }} {{ row.unit }}</td>
              <td class="text-center">{{ row.expiryDate | date: 'yyyy-MM-dd' }}</td>
              <td class="truncate" [title]="row.supplier || '—'">{{ row.supplier || '—' }}</td>
              <td><span [ngClass]="statusClass(row.status)">{{ statusText(row.status) }}</span></td>
            </tr>
          </tbody>
        </table>
      </ng-container>
    </ng-container>
    <ng-template #loading>
      <div class="supplies__empty">Загрузка...</div>
    </ng-template>
    <ng-template #empty>
      <div class="supplies__empty">Поставки пока не добавлены</div>
    </ng-template>
  </div>
</section>

<section class="supplies-dialog" *ngIf="dialogOpen()">
  <div class="supplies-dialog__backdrop" (click)="closeDialog()"></div>
  <div
    class="supplies-dialog__panel"
    role="dialog"
    aria-modal="true"
    aria-labelledby="supplies-dialog-title"
    (click)="$event.stopPropagation()"
  >
    <form class="supplies-dialog__form" (ngSubmit)="submit()" novalidate>
      <header class="supplies-dialog__header">
        <h2 id="supplies-dialog-title">Новая поставка</h2>
      </header>

      <div class="supplies-dialog__body">
        <section class="supplies-dialog__section">
          <h3 class="supplies-dialog__section-title">Детали документа</h3>
          <div class="supplies-dialog__grid">
            <label class="supplies-field">
              <span class="supplies-field__label">Номер документа *</span>
              <input
                class="supplies-field__input"
                type="text"
                formControlName="docNo"
                placeholder="Например, PO-001234"
              />
              <span class="supplies-field__error" *ngIf="form.controls.docNo.touched && form.controls.docNo.invalid">
                Укажите номер документа
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">Дата прихода *</span>
              <input class="supplies-field__input" type="date" formControlName="arrivalDate" />
              <span class="supplies-field__error" *ngIf="form.controls.arrivalDate.touched && form.controls.arrivalDate.invalid">
                Выберите дату прихода
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">Склад *</span>
              <input class="supplies-field__input" type="text" formControlName="warehouse" placeholder="Например, Главный склад" />
              <span class="supplies-field__error" *ngIf="form.controls.warehouse.touched && form.controls.warehouse.invalid">
                Укажите склад
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">Ответственный</span>
              <input class="supplies-field__input" type="text" formControlName="responsible" placeholder="ФИО" />
            </label>
          </div>
        </section>

        <section class="supplies-dialog__section">
          <h3 class="supplies-dialog__section-title">Товар</h3>
          <div class="supplies-dialog__grid">
            <label class="supplies-field supplies-field--full">
              <span class="supplies-field__label">Позиция каталога *</span>
              <select class="supplies-field__input" formControlName="productId">
                <option value="">Выберите товар</option>
                <option *ngFor="let product of products$ | async" [value]="product.id">
                  {{ product.name }} ({{ product.sku }})
                </option>
              </select>
              <span class="supplies-field__error" *ngIf="form.controls.productId.touched && form.controls.productId.invalid">
                Выберите товар из каталога
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">Количество *</span>
              <input class="supplies-field__input" type="number" min="0.01" step="0.01" formControlName="qty" />
              <span class="supplies-field__error" *ngIf="form.controls.qty.touched && form.controls.qty.invalid">
                Количество должно быть больше нуля
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">Срок годности *</span>
              <input class="supplies-field__input" type="date" formControlName="expiryDate" />
              <span class="supplies-field__error" *ngIf="form.controls.expiryDate.touched && form.controls.expiryDate.invalid">
                Укажите срок годности
              </span>
            </label>
          </div>

          <ng-container *ngIf="selectedProduct() as product">
            <dl class="supplies-dialog__product-meta">
              <div class="supplies-dialog__meta-row">
                <dt>SKU</dt>
                <dd>{{ product.sku }}</dd>
              </div>
              <div class="supplies-dialog__meta-row">
                <dt>Ед. изм.</dt>
                <dd>{{ product.unit }}</dd>
              </div>
              <div class="supplies-dialog__meta-row">
                <dt>Поставщик</dt>
                <dd>{{ product.supplier || '—' }}</dd>
              </div>
            </dl>
          </ng-container>
        </section>
      </div>

      <footer class="supplies-dialog__footer">
        <button type="button" class="btn btn-outline" (click)="closeDialog()">Отмена</button>
        <button type="submit" class="btn btn-primary">Сохранить</button>
      </footer>
    </form>
  </div>
</section>
