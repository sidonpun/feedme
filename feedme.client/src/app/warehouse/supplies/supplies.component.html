
<section class="supplies">
  <section class="kpis" *ngIf="kpi() as metrics">
    <div class="kpi">
      <div class="kpi__label">–ü–æ—Å—Ç–∞–≤–æ–∫ –∑–∞ 7 –¥–Ω–µ–π</div>
      <div class="kpi__value">{{ metrics.weekSupplies }}</div>
    </div>
    <div class="kpi">
      <div class="kpi__label">–°—É–º–º–∞ –∑–∞–∫—É–ø–æ–∫ / 7 –¥–Ω.</div>
      <div class="kpi__value">{{ metrics.weekSpend | currency: 'RUB' }}</div>
    </div>
    <div class="kpi">
      <div class="kpi__label">–ü–æ–∑–∏—Ü–∏–π –Ω–∞ —Å–∫–ª–∞–¥–µ</div>
      <div class="kpi__value">{{ metrics.items }}</div>
    </div>
    <div class="kpi">
      <div class="kpi__label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
      <div class="kpi__value kpi__value--danger">{{ metrics.expired }}</div>
    </div>
  </section>


  <section class="filters">
    <input class="fm-input w-280" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, SKU –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é" />

    <input class="fm-input w-140" type="date" />
    <input class="fm-input w-140" type="date" />
    <button class="btn btn-outline" type="button">–°–±—Ä–æ—Å</button>
    <button class="btn btn-secondary" type="button">–≠–∫—Å–ø–æ—Ä—Ç</button>
    <button class="btn btn-secondary" type="button" (click)="openImportDialog()">–ò–º–ø–æ—Ä—Ç</button>
    <button class="btn btn-primary" type="button" (click)="openDialog()">+ –ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞</button>
  </section>


  <div class="card supplies__table-card">
    <div class="card__content supplies__table-wrapper">
      <ng-container *ngIf="rows$ | async as rows; else loading">
        <table class="fm-table" *ngIf="rows.length > 0; else empty">
          <thead>
            <tr>
              <th class="text-center">
                <input type="checkbox" aria-label="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" />
              </th>
              <th>‚Ññ –¥–æ–∫.</th>
              <th>–î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞</th>
              <th>–°–∫–ª–∞–¥</th>
              <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
              <th>SKU</th>
              <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th class="text-right">–ö–æ–ª-–≤–æ</th>
              <th class="text-center">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</th>
              <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th class="text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of rows; trackBy: trackBySupplyId">
              <td class="text-center">
                <input type="checkbox" [attr.aria-label]="'–í—ã–±—Ä–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É ' + row.docNo" />
              </td>
              <td class="mono">{{ row.docNo }}</td>
              <td class="text-center">{{ row.arrivalDate | date: 'dd.MM.yyyy' }}</td>
              <td>{{ row.warehouse }}</td>
              <td>{{ row.responsible || '‚Äî' }}</td>
              <td class="mono">{{ row.sku }}</td>
              <td class="truncate" [title]="row.name">{{ row.name }}</td>
              <td class="text-right">{{ row.qty | number: '1.0-2' }} {{ row.unit }}</td>
              <td class="text-center">{{ row.expiryDate | date: 'dd.MM.yyyy' }}</td>
              <td class="truncate" [title]="row.supplier || '‚Äî'">{{ row.supplier || '‚Äî' }}</td>
              <td>
                <span [ngClass]="statusClass(row.status)">{{ statusText(row.status) }}</span>
              </td>
              <td class="text-right">
                <button class="icon-btn" type="button" aria-label="–°–ø–∏—Å–∞—Ç—å">üóë</button>
                <button class="icon-btn" type="button" aria-label="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å">‚áÑ</button>
                <button class="icon-btn" type="button" aria-label="–ü–µ—á–∞—Ç—å">üñ®</button>
              </td>
            </tr>
          </tbody>
        </table>
        <ng-template #empty>
          <div class="supplies__empty">–ü–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>
        </ng-template>
      </ng-container>
      <ng-template #loading>
        <div class="supplies__empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </ng-template>

    </div>

    <button class="btn btn-outline" type="button" (click)="resetFilters()">–°–±—Ä–æ—Å</button>
    <button class="btn btn-secondary" type="button">–≠–∫—Å–ø–æ—Ä—Ç</button>

    <button class="btn btn-primary" type="button" (click)="openDialog()">+ –ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞</button>
  </div>
</header>

<section class="kpis">
  <article class="kpis__item">
    <span class="kpis__label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏</span>
    <span class="kpis__value">{{ supplyKpis().ok }}</span>
  </article>
  <article class="kpis__item">
    <span class="kpis__label">–°–∫–æ—Ä–æ —Å—Ä–æ–∫</span>
    <span class="kpis__value">{{ supplyKpis().warning }}</span>
  </article>
  <article class="kpis__item">
    <span class="kpis__label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
    <span class="kpis__value">{{ supplyKpis().expired }}</span>
  </article>
  <article class="kpis__item">
    <span class="kpis__label">–í—Å–µ–≥–æ –ø–æ—Å—Ç–∞–≤–æ–∫</span>
    <span class="kpis__value">{{ supplyKpis().total }}</span>
  </article>
</section>

<section class="filters">
  <input class="fm-input w-280" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, SKU –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é" />
  <input class="fm-input w-140" type="date" />
  <input class="fm-input w-140" type="date" />
  <button class="btn btn-outline" type="button">–°–±—Ä–æ—Å</button>
  <button class="btn btn-secondary" type="button">–≠–∫—Å–ø–æ—Ä—Ç</button>
</section>

<ng-container *ngIf="importDialogOpen()">
  <div class="fm-dialog-backdrop" (click)="closeImportDialog()"></div>
  <div class="fm-dialog square" role="dialog" aria-modal="true" aria-labelledby="supplies-import-title">
    <header class="fm-dialog__header">
      <div class="fm-dialog__title" id="supplies-import-title">–ò–º–ø–æ—Ä—Ç CSV</div>
      <button class="fm-dialog__close" type="button" (click)="closeImportDialog()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </header>

    <section
      class="fm-dropzone"
      (dragover)="onDragOver($event)"
      (drop)="onDrop($event)"
    >
      <div class="fm-dropzone__icon">‚¨á</div>
      <div class="fm-dropzone__title">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª CSV —Å—é–¥–∞</div>
      <div class="fm-dropzone__sub">
        –∏–ª–∏
        <label class="link">
          <input type="file" accept=".csv,text/csv" (change)="onFile($event)" hidden />
          –≤—ã–±–µ—Ä–∏—Ç–µ —Å –¥–∏—Å–∫–∞
        </label>
      </div>
      <div class="fm-dropzone__file" *ngIf="selectedFileName() as fileName">–í—ã–±—Ä–∞–Ω–æ: {{ fileName }}</div>
    </section>

    <footer class="fm-dialog__footer">
      <button class="btn btn-outline" type="button" (click)="closeImportDialog()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" type="button" (click)="mockImport()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </footer>
  </div>
</ng-container>


<section class="supplies-dialog" *ngIf="dialogOpen()">
  <div class="supplies-dialog__backdrop" (click)="closeDialog()"></div>
  <div
    class="supplies-dialog__panel"
    role="dialog"
    aria-modal="true"
    aria-labelledby="supplies-dialog-title"
    (click)="$event.stopPropagation()"
  >
    <form class="supplies-dialog__form" (ngSubmit)="submit()" novalidate>
      <header class="supplies-dialog__header">
        <h2 id="supplies-dialog-title">–ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞</h2>
      </header>

      <div class="supplies-dialog__body">
        <section class="supplies-dialog__section">
          <h3 class="supplies-dialog__section-title">–î–µ—Ç–∞–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
          <div class="supplies-dialog__grid">
            <label class="supplies-field">
              <span class="supplies-field__label">–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ *</span>
              <input
                class="supplies-field__input"
                type="text"
                formControlName="docNo"
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, PO-001234"
              />
              <span class="supplies-field__error" *ngIf="form.controls.docNo.touched && form.controls.docNo.invalid">
                –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">–î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ *</span>
              <input class="supplies-field__input" type="date" formControlName="arrivalDate" />
              <span class="supplies-field__error" *ngIf="form.controls.arrivalDate.touched && form.controls.arrivalDate.invalid">
                –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø—Ä–∏—Ö–æ–¥–∞
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">–°–∫–ª–∞–¥ *</span>
              <input class="supplies-field__input" type="text" formControlName="warehouse" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ì–ª–∞–≤–Ω—ã–π —Å–∫–ª–∞–¥" />
              <span class="supplies-field__error" *ngIf="form.controls.warehouse.touched && form.controls.warehouse.invalid">
                –£–∫–∞–∂–∏—Ç–µ —Å–∫–ª–∞–¥
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</span>
              <input class="supplies-field__input" type="text" formControlName="responsible" placeholder="–§–ò–û" />
            </label>
          </div>
        </section>

        <section class="supplies-dialog__section">
          <h3 class="supplies-dialog__section-title">–¢–æ–≤–∞—Ä</h3>
          <div class="supplies-dialog__grid">
            <label class="supplies-field supplies-field--full">
              <span class="supplies-field__label">–ü–æ–∑–∏—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ *</span>
              <select class="supplies-field__input" formControlName="productId">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
                <option *ngFor="let product of products$ | async" [value]="product.id">
                  {{ product.name }} ({{ product.sku }})
                </option>
              </select>
              <span class="supplies-field__error" *ngIf="form.controls.productId.touched && form.controls.productId.invalid">
                –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</span>
              <input class="supplies-field__input" type="number" min="0.01" step="0.01" formControlName="qty" />
              <span class="supplies-field__error" *ngIf="form.controls.qty.touched && form.controls.qty.invalid">
                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è
              </span>
            </label>
            <label class="supplies-field">
              <span class="supplies-field__label">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ *</span>
              <input class="supplies-field__input" type="date" formControlName="expiryDate" />
              <span class="supplies-field__error" *ngIf="form.controls.expiryDate.touched && form.controls.expiryDate.invalid">
                –£–∫–∞–∂–∏—Ç–µ —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏
              </span>
            </label>
          </div>

          <ng-container *ngIf="selectedProduct() as product">
            <dl class="supplies-dialog__product-meta">
              <div class="supplies-dialog__meta-row">
                <dt>SKU</dt>
                <dd>{{ product.sku }}</dd>
              </div>
              <div class="supplies-dialog__meta-row">
                <dt>–ï–¥. –∏–∑–º.</dt>
                <dd>{{ product.unit }}</dd>
              </div>
              <div class="supplies-dialog__meta-row">
                <dt>–ü–æ—Å—Ç–∞–≤—â–∏–∫</dt>
                <dd>{{ product.supplier || '‚Äî' }}</dd>
              </div>
            </dl>
          </ng-container>
        </section>
      </div>

      <footer class="supplies-dialog__footer">
        <button type="button" class="supplies__btn supplies__btn--outline" (click)="closeDialog()">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="supplies__btn supplies__btn--primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

      </footer>
    </form>
  </div>
</section>
