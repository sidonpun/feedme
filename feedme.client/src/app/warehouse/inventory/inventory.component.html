<div class="inventory-tab">
  <section *ngIf="filteredDocuments().length > 0; else emptyState" class="inventory-tab__section">
    <header class="inventory-tab__summary">
      <div class="inventory-tab__summary-item">
        Показано {{ filteredDocuments().length }} из {{ documents().length }}
      </div>
      <div class="inventory-tab__summary-item">
        Отклонение:
        <span class="inventory-tab__summary-value" [ngClass]="differenceClass(totalDifference())">
          {{ formatCurrency(totalDifference()) }}
        </span>
      </div>
      <button
        type="button"
        class="btn btn-outline btn-sm"
        (click)="startDeleteSelection()"
        [disabled]="selection().length === 0"
      >
        Удалить выбранные
      </button>
    </header>

    <div class="warehouse-page__table-wrapper">
      <table class="warehouse-page__table">
        <thead>
          <tr>
            <th class="warehouse-page__cell warehouse-page__cell--checkbox">
              <input
                type="checkbox"
                class="checkbox"
                [checked]="selection().length && selection().length === filteredDocuments().length"
                (change)="handleAllCheckboxChange($event)"
              />
            </th>
            <th class="warehouse-page__cell">№ документа</th>
            <th class="warehouse-page__cell">Статус</th>
            <th class="warehouse-page__cell">Склад</th>
            <th class="warehouse-page__cell">Ответственный</th>
            <th class="warehouse-page__cell">Начало</th>
            <th class="warehouse-page__cell">Завершение</th>
            <th class="warehouse-page__cell warehouse-page__cell--right">Позиций</th>
            <th class="warehouse-page__cell warehouse-page__cell--right">Отклонение</th>
            <th class="warehouse-page__cell warehouse-page__cell--icon"></th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let document of filteredDocuments(); trackBy: trackById"
            class="warehouse-page__row"
            (dblclick)="openDrawer(document)"
          >
            <td class="warehouse-page__cell warehouse-page__cell--checkbox">
              <input
                type="checkbox"
                class="checkbox"
                [checked]="selection().includes(document.id)"
                (click)="$event.stopPropagation()"
                (change)="handleRowCheckbox(document.id, $event)"
              />
            </td>
            <td class="warehouse-page__cell">
              <button
                type="button"
                class="inventory-tab__link"
                (click)="openDrawer(document)"
              >
                {{ document.number }}
              </button>
            </td>
            <td class="warehouse-page__cell">
              <span class="badge" [ngClass]="statusClass(document.status)">
                {{ statusLabel(document.status) }}
              </span>
            </td>
            <td class="warehouse-page__cell">{{ document.warehouse }}</td>
            <td class="warehouse-page__cell">{{ document.responsible || '—' }}</td>
            <td class="warehouse-page__cell">{{ formatDate(document.startedAt) }}</td>
            <td class="warehouse-page__cell">{{ formatDate(document.completedAt) }}</td>
            <td class="warehouse-page__cell warehouse-page__cell--right">{{ document.positions }}</td>
            <td class="warehouse-page__cell warehouse-page__cell--right">
              <span [ngClass]="differenceClass(document.totalDifference)">
                {{ formatCurrency(document.totalDifference) }}
              </span>
            </td>
            <td class="warehouse-page__cell warehouse-page__cell--icon">
              <div class="inventory-tab__actions">
                <button
                  type="button"
                  class="inventory-tab__action"
                  (click)="openEditDialog(document); $event.stopPropagation()"
                >
                  Редактировать
                </button>
                <button
                  type="button"
                  class="inventory-tab__action"
                  (click)="startDelete(document); $event.stopPropagation()"
                >
                  Удалить
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <footer class="inventory-tab__footer">
      <div>
        Всего документов: {{ documents().length }}
      </div>
      <div>
        Выбрано: {{ selection().length }}
      </div>
    </footer>
  </section>

  <ng-template #emptyState>
    <app-empty
      title="Инвентаризация"
      subtitle="Создайте обход или запустите экспресс-пересчёт"
    ></app-empty>
  </ng-template>

  <aside class="warehouse-page__drawer" *ngIf="activeDocument() as document">
    <section class="warehouse-page__drawer-content">
      <header class="warehouse-page__drawer-header">
        <div>
          <div class="warehouse-page__drawer-sku">Документ {{ document.number }}</div>
          <div class="warehouse-page__drawer-title">{{ document.warehouse }}</div>
          <div class="warehouse-page__drawer-meta">
            Ответственный: {{ document.responsible || 'Не назначен' }}
          </div>
        </div>
        <span class="badge" [ngClass]="statusClass(document.status)">
          {{ statusLabel(document.status) }}
        </span>
      </header>
      <div class="warehouse-page__drawer-grid">
        <app-field label="Дата начала" [value]="formatDate(document.startedAt)"></app-field>
        <app-field label="Завершение" [value]="formatDate(document.completedAt)"></app-field>
        <app-field label="Позиций" [value]="document.positions"></app-field>
        <app-field label="Отклонение" [value]="formatCurrency(document.totalDifference)"></app-field>
      </div>
      <div class="inventory-tab__items">
        <table>
          <thead>
            <tr>
              <th>SKU</th>
              <th>Название</th>
              <th>Категория</th>
              <th class="align-right">Ожидалось</th>
              <th class="align-right">Посчитано</th>
              <th class="align-right">Отклонение</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of document.items">
              <td>{{ item.sku }}</td>
              <td>{{ item.itemName }}</td>
              <td>{{ item.category }}</td>
              <td class="align-right">{{ item.expectedQuantity | number: '1.0-3' }} {{ item.unit }}</td>
              <td class="align-right">{{ item.countedQuantity | number: '1.0-3' }} {{ item.unit }}</td>
              <td class="align-right" [ngClass]="differenceClass(item.differenceQuantity)">
                {{ item.differenceQuantity | number: '1.0-3' }} {{ item.unit }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <footer class="warehouse-page__drawer-actions">
        <button type="button" class="btn btn-ghost btn-sm" (click)="closeDrawer()">Закрыть</button>
      </footer>
    </section>
  </aside>

  <div class="inventory-dialog-backdrop" *ngIf="formDialogOpen()">
    <section class="inventory-dialog" role="dialog" aria-modal="true">
      <header class="inventory-dialog__header">
        <h2>{{ formTitle() }}</h2>
        <button type="button" class="inventory-dialog__close" (click)="closeFormDialog()">×</button>
      </header>
      <form class="inventory-dialog__form" [formGroup]="inventoryForm" (ngSubmit)="submitForm()">
        <div class="inventory-dialog__grid">
          <label class="inventory-dialog__field">
            <span>№ документа</span>
            <input class="input" formControlName="number" />
          </label>
          <label class="inventory-dialog__field">
            <span>Склад</span>
            <input class="input" formControlName="warehouse" />
          </label>
          <label class="inventory-dialog__field">
            <span>Ответственный</span>
            <input class="input" formControlName="responsible" />
          </label>
          <label class="inventory-dialog__field">
            <span>Дата начала</span>
            <input class="input" type="date" formControlName="startedAt" />
          </label>
          <label class="inventory-dialog__field">
            <span>Завершение</span>
            <input class="input" type="date" formControlName="completedAt" />
          </label>
          <label class="inventory-dialog__field">
            <span>Статус</span>
            <select class="select" formControlName="status">
              <option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </label>
        </div>

        <section class="inventory-dialog__items">
          <header class="inventory-dialog__items-header">
            <h3>Позиции</h3>
            <button type="button" class="btn btn-outline btn-sm" (click)="addItem()">Добавить позицию</button>
          </header>
          <div class="inventory-dialog__items-table" formArrayName="items">
            <div
              class="inventory-dialog__item-row"
              *ngFor="let group of itemsArray.controls; let i = index"
              [formGroupName]="i"
            >
              <div class="inventory-dialog__item-field">
                <span>Каталог ID</span>
                <input class="input" formControlName="catalogItemId" />
              </div>
              <div class="inventory-dialog__item-field">
                <span>SKU</span>
                <input class="input" formControlName="sku" />
              </div>
              <div class="inventory-dialog__item-field inventory-dialog__item-field--wide">
                <span>Название</span>
                <input class="input" formControlName="itemName" />
              </div>
              <div class="inventory-dialog__item-field">
                <span>Категория</span>
                <input class="input" formControlName="category" />
              </div>
              <div class="inventory-dialog__item-field">
                <span>Ед. изм.</span>
                <input class="input" formControlName="unit" />
              </div>
              <div class="inventory-dialog__item-field">
                <span>Ожидалось</span>
                <input class="input" type="number" min="0" step="0.001" formControlName="expectedQuantity" />
              </div>
              <div class="inventory-dialog__item-field">
                <span>Посчитано</span>
                <input class="input" type="number" min="0" step="0.001" formControlName="countedQuantity" />
              </div>
              <div class="inventory-dialog__item-field">
                <span>Цена</span>
                <input class="input" type="number" min="0" step="0.01" formControlName="unitPrice" />
              </div>
              <button
                type="button"
                class="inventory-dialog__remove"
                (click)="removeItem(i)"
                [disabled]="itemsArray.length === 1"
              >
                Удалить
              </button>
            </div>
          </div>
        </section>

        <div class="inventory-dialog__totals">
          <div>
            <span>Ожидалось</span>
            <strong>{{ formatCurrency(formTotals().expected) }}</strong>
          </div>
          <div>
            <span>Посчитано</span>
            <strong>{{ formatCurrency(formTotals().counted) }}</strong>
          </div>
          <div>
            <span>Отклонение</span>
            <strong [ngClass]="differenceClass(formTotals().difference)">
              {{ formatCurrency(formTotals().difference) }}
            </strong>
          </div>
        </div>

        <footer class="inventory-dialog__actions">
          <button type="button" class="btn btn-outline" (click)="closeFormDialog()">Отмена</button>
          <button type="submit" class="btn" [disabled]="inventoryForm.invalid">Сохранить</button>
        </footer>
      </form>
    </section>
  </div>

  <div class="inventory-dialog-backdrop" *ngIf="deleteDialogOpen()">
    <section class="inventory-dialog inventory-dialog--confirm" role="dialog" aria-modal="true">
      <header class="inventory-dialog__header">
        <h2>Удалить инвентаризацию</h2>
      </header>
      <div class="inventory-dialog__content">
        <ng-container *ngIf="deleteTargetIds().length === 1; else deleteMany">
          <p>Удалить выбранный документ? Действие нельзя отменить.</p>
        </ng-container>
        <ng-template #deleteMany>
          <p>Удалить выбранные {{ deleteTargetIds().length }} документов? Действие нельзя отменить.</p>
        </ng-template>
      </div>
      <footer class="inventory-dialog__actions">
        <button type="button" class="btn btn-outline" (click)="cancelDelete()">Отмена</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">Удалить</button>
      </footer>
    </section>
  </div>
</div>
