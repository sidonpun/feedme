<section class="catalog">
  <div class="catalog__header">
    <div>
      <h1 class="catalog__title">Каталог</h1>
      <p class="catalog__subtitle">{{ productsCountLabel() }}</p>
    </div>
    <button type="button" class="button button--primary" (click)="openDialog()">
      + Новый товар
    </button>
  </div>

  <ng-container *ngIf="totalProductsCount(); else emptyCatalog">
    <div class="catalog__table-panel">
      <div class="catalog__table-toolbar">
        <div class="catalog__table-search">
          <input
            #searchInput
            class="catalog__table-search-input"
            type="search"
            placeholder="Поиск по каталогу"
            [value]="searchQuery()"
            (input)="updateSearch(searchInput.value)"
            aria-label="Поиск по каталогу"
          />
        </div>
        <div class="catalog__table-meta" *ngIf="filteredProductsCount()">
          {{ paginationStatusLabel() }}
        </div>
      </div>

      <ng-container *ngIf="filteredProductsCount(); else noSearchResults">
        <div class="catalog__table-container">
          <table class="fm-table catalog__table">
            <thead>
              <tr>
                <th [attr.aria-sort]="ariaSort('name')">
                  <button
                    type="button"
                    class="table__sort-trigger"
                    (click)="changeSort('name')"
                    [attr.aria-label]="sortAriaLabel('name', 'Название')"
                  >
                    <span class="table__sort-label">Название</span>
                    <span class="table__sort-indicator" aria-hidden="true">{{ sortIndicator('name') }}</span>
                  </button>
                </th>
                <th [attr.aria-sort]="ariaSort('type')">
                  <button
                    type="button"
                    class="table__sort-trigger"
                    (click)="changeSort('type')"
                    [attr.aria-label]="sortAriaLabel('type', 'Тип')"
                  >
                    <span class="table__sort-label">Тип</span>
                    <span class="table__sort-indicator" aria-hidden="true">{{ sortIndicator('type') }}</span>
                  </button>
                </th>
                <th class="is-mono" [attr.aria-sort]="ariaSort('sku')">
                  <button
                    type="button"
                    class="table__sort-trigger table__sort-trigger--align-right"
                    (click)="changeSort('sku')"
                    [attr.aria-label]="sortAriaLabel('sku', 'SKU')"
                  >
                    <span class="table__sort-label">SKU</span>
                    <span class="table__sort-indicator" aria-hidden="true">{{ sortIndicator('sku') }}</span>
                  </button>
                </th>
                <th [attr.aria-sort]="ariaSort('category')">
                  <button
                    type="button"
                    class="table__sort-trigger"
                    (click)="changeSort('category')"
                    [attr.aria-label]="sortAriaLabel('category', 'Категория')"
                  >
                    <span class="table__sort-label">Категория</span>
                    <span class="table__sort-indicator" aria-hidden="true">{{ sortIndicator('category') }}</span>
                  </button>
                </th>
                <th class="is-centered" [attr.aria-sort]="ariaSort('unit')">
                  <button
                    type="button"
                    class="table__sort-trigger table__sort-trigger--align-center"
                    (click)="changeSort('unit')"
                    [attr.aria-label]="sortAriaLabel('unit', 'Единица измерения')"
                  >
                    <span class="table__sort-label">Ед. изм.</span>
                    <span class="table__sort-indicator" aria-hidden="true">{{ sortIndicator('unit') }}</span>
                  </button>
                </th>
                <th class="is-right" [attr.aria-sort]="ariaSort('purchasePrice')">
                  <button
                    type="button"
                    class="table__sort-trigger table__sort-trigger--align-right"
                    (click)="changeSort('purchasePrice')"
                    [attr.aria-label]="sortAriaLabel('purchasePrice', 'Цена закупки')"
                  >
                    <span class="table__sort-label">Цена закупки</span>
                    <span class="table__sort-indicator" aria-hidden="true">
                      {{ sortIndicator('purchasePrice') }}
                    </span>
                  </button>
                </th>
                <th class="is-right" [attr.aria-sort]="ariaSort('salePrice')">
                  <button
                    type="button"
                    class="table__sort-trigger table__sort-trigger--align-right"
                    (click)="changeSort('salePrice')"
                    [attr.aria-label]="sortAriaLabel('salePrice', 'Цена продажи')"
                  >
                    <span class="table__sort-label">Цена продажи</span>
                    <span class="table__sort-indicator" aria-hidden="true">
                      {{ sortIndicator('salePrice') }}
                    </span>
                  </button>
                </th>
                <th [attr.aria-sort]="ariaSort('supplierMain')">
                  <button
                    type="button"
                    class="table__sort-trigger"
                    (click)="changeSort('supplierMain')"
                    [attr.aria-label]="sortAriaLabel('supplierMain', 'Поставщик')"
                  >
                    <span class="table__sort-label">Поставщик</span>
                    <span class="table__sort-indicator" aria-hidden="true">
                      {{ sortIndicator('supplierMain') }}
                    </span>
                  </button>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of paginatedProducts(); trackBy: trackByProductId">
                <td>
                  <div class="truncate" [title]="product.name">{{ product.name }}</div>
                </td>
                <td>{{ product.type }}</td>
                <td class="is-mono">
                  <span class="truncate" [title]="product.sku">{{ product.sku }}</span>
                </td>
                <td>
                  <div class="truncate" [title]="product.category">{{ product.category }}</div>
                </td>
                <td class="is-centered">{{ product.unit }}</td>
                <td class="is-right">
                  {{ product.purchasePrice ?? '—' }}
                </td>
                <td class="is-right">
                  {{ product.salePrice ?? '—' }}
                </td>
                <td>
                  <div class="truncate" [title]="product.supplierMain || '—'">
                    {{ product.supplierMain || '—' }}
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <nav class="catalog__pagination" *ngIf="hasPagination()" aria-label="Навигация по страницам каталога">
          <button
            type="button"
            class="catalog__pagination-control"
            (click)="previousPage()"
            [disabled]="currentPage() === 1"
            aria-label="Предыдущая страница"
          >
            Назад
          </button>

          <ng-container *ngFor="let button of paginationButtons(); trackBy: trackPaginationButton">
            <button
              *ngIf="button.kind === 'page'; else paginationEllipsis"
              type="button"
              class="catalog__pagination-page"
              [class.catalog__pagination-page--active]="button.active"
              (click)="goToPage(button.value)"
              [attr.aria-current]="button.active ? 'page' : null"
            >
              {{ button.value }}
            </button>
          </ng-container>

          <button
            type="button"
            class="catalog__pagination-control"
            (click)="nextPage()"
            [disabled]="currentPage() === totalPages()"
            aria-label="Следующая страница"
          >
            Вперёд
          </button>

          <ng-template #paginationEllipsis>
            <span class="catalog__pagination-ellipsis" aria-hidden="true">...</span>
          </ng-template>
        </nav>
      </ng-container>
    </div>

  </ng-container>
  <ng-template #emptyCatalog>
    <div class="catalog__empty">Каталог пока пуст. Добавьте первую позицию.</div>
  </ng-template>
  <ng-template #noSearchResults>
    <div class="catalog__empty">
      По запросу «{{ normalizedSearchQuery() }}» ничего не найдено.
    </div>
  </ng-template>

  <div class="dialog-backdrop" *ngIf="dialogOpen()">
    <form class="dialog" [formGroup]="productForm" (ngSubmit)="submit()">
      <header class="dialog__header">
        <h2 class="dialog__title">Новый товар</h2>
        <button type="button" class="dialog__close" aria-label="Закрыть" (click)="closeDialog()">×</button>
      </header>

      <section class="dialog__section">
        <h3 class="dialog__section-title">Основная информация</h3>
        <div class="form-grid">
          <label class="field" [ngClass]="{ 'field--invalid': productForm.controls.name.touched && productForm.controls.name.invalid }">
            <span class="field__label">Название товара *</span>
            <input class="field__control" type="text" formControlName="name" placeholder="Например, Курица гриль" />
            <span class="field__error" *ngIf="productForm.controls.name.touched && productForm.controls.name.invalid">
              Укажите название товара
            </span>
          </label>

          <label class="field">
            <span class="field__label">Тип номенклатуры</span>
            <select class="field__control" formControlName="type">
              <option value="Товар">Товар</option>
              <option value="Заготовка">Заготовка</option>
              <option value="Полуфабрикат">Полуфабрикат</option>
            </select>
          </label>

          <label class="field" [ngClass]="{ 'field--invalid': productForm.controls.sku.touched && productForm.controls.sku.invalid }">
            <span class="field__label">Номенклатурный код *</span>
            <input class="field__control" type="text" formControlName="sku" placeholder="MEAT-003" />
            <span class="field__error" *ngIf="productForm.controls.sku.touched && productForm.controls.sku.invalid">
              Укажите SKU
            </span>
          </label>

          <label class="field" [ngClass]="{ 'field--invalid': productForm.controls.category.touched && productForm.controls.category.invalid }">
            <span class="field__label">Категория *</span>
            <input class="field__control" type="text" formControlName="category" placeholder="Мясные блюда" />
            <span class="field__error" *ngIf="productForm.controls.category.touched && productForm.controls.category.invalid">
              Укажите категорию
            </span>
          </label>

          <label class="field" [ngClass]="{ 'field--invalid': productForm.controls.unit.touched && productForm.controls.unit.invalid }">
            <span class="field__label">Единица измерения *</span>
            <select class="field__control" formControlName="unit">
              <option value="кг">кг</option>
              <option value="л">л</option>
              <option value="шт">шт</option>
            </select>
            <span class="field__error" *ngIf="productForm.controls.unit.touched && productForm.controls.unit.invalid">
              Укажите единицу измерения
            </span>
          </label>

          <label class="field">
            <span class="field__label">Вес единицы, кг</span>
            <input class="field__control" type="number" formControlName="unitWeight" min="0" step="0.01" />
          </label>

          <label class="field">
            <span class="field__label">Метод списания</span>
            <select class="field__control" formControlName="writeoff">
              <option value="FIFO">FIFO</option>
              <option value="FEFO">FEFO</option>
              <option value="LIFO">LIFO</option>
            </select>
          </label>

          <label class="field">
            <span class="field__label">Аллергены</span>
            <input class="field__control" type="text" formControlName="allergens" placeholder="Например, молоко" />
          </label>

          <label class="checkbox">
            <input type="checkbox" formControlName="needsPacking" />
            <span>Требует фасовки</span>
          </label>

          <label class="checkbox">
            <input type="checkbox" formControlName="perishableAfterOpen" />
            <span>Портится после вскрытия</span>
          </label>
        </div>
      </section>

      <section class="dialog__section">
        <h3 class="dialog__section-title">Закупка и логистика</h3>
        <div class="form-grid">
          <label class="field">
            <span class="field__label">Поставщик (основной)</span>
            <input class="field__control" type="text" formControlName="supplierMain" placeholder="ООО Курица Дуо" />
          </label>

          <label class="field">
            <span class="field__label">Срок поставки, дней</span>
            <input class="field__control" type="number" formControlName="leadTimeDays" min="0" />
          </label>

          <label class="field">
            <span class="field__label">Оценочная себестоимость</span>
            <input class="field__control" type="number" formControlName="costEst" min="0" step="0.01" />
          </label>

          <label class="field">
            <span class="field__label">Ставка НДС</span>
            <input class="field__control" type="text" formControlName="vat" placeholder="Без НДС / 10% / 20%" />
          </label>

          <label class="field">
            <span class="field__label">Цена закупки</span>
            <input class="field__control" type="number" formControlName="purchasePrice" min="0" step="0.01" />
          </label>

          <label class="field">
            <span class="field__label">Цена продажи</span>
            <input class="field__control" type="number" formControlName="salePrice" min="0" step="0.01" />
          </label>

          <label class="field">
            <span class="field__label">Код ТН ВЭД</span>
            <input class="field__control" type="text" formControlName="tnvCode" placeholder="1602310000" />
          </label>

          <label class="checkbox">
            <input type="checkbox" formControlName="marked" />
            <span>Маркируемый товар</span>
          </label>

          <label class="checkbox">
            <input type="checkbox" formControlName="alcohol" />
            <span>Алкогольная продукция</span>
          </label>
        </div>
      </section>

      <footer class="dialog__actions">
        <button type="button" class="button" (click)="closeDialog()">Отмена</button>
        <button type="submit" class="button button--primary" [disabled]="submitting()">
          {{ submitting() ? 'Сохранение…' : 'Сохранить' }}
        </button>
      </footer>
    </form>
  </div>
</section>
