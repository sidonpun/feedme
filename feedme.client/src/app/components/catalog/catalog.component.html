<div class="catalog-page">
  <section class="catalog-card" #catalogCard>
    <header class="catalog-header">
      <div class="catalog-header__row catalog-header__row--tabs">
        <div class="tabs" role="tablist" aria-label="Каталог">
          <button
            type="button"
            class="tab"
            role="tab"
            (click)="activeTab='info'"
            [class.active]="activeTab==='info'"
            [attr.aria-selected]="activeTab === 'info'"
          >
            Основная информация
          </button>
          <button
            type="button"
            class="tab"
            role="tab"
            (click)="activeTab='logistics'"
            [class.active]="activeTab==='logistics'"
            [attr.aria-selected]="activeTab === 'logistics'"
          >
            Закупка и логистика
          </button>
        </div>
      </div>
      <div class="catalog-header__row catalog-header__row--toolbar">
        <label class="catalog-toolbar__search" aria-label="Поиск по номеру, SKU или названию">
          <input
            #searchInput
            type="search"
            class="catalog-toolbar__search-input"
            placeholder="Поиск по номеру, SKU или названию"
            [value]="searchQuery()"
            (input)="onSearch(searchInput.value)"
          />
        </label>
        <div class="catalog-toolbar__actions">
          <button type="button" class="catalog-toolbar__button" (click)="onResetFilters()">
            Сброс
          </button>
          <button type="button" class="catalog-toolbar__button" (click)="onImportClick()">
            Импорт
          </button>
          <button type="button" class="catalog-toolbar__button" (click)="onExportClick()">
            Экспорт
          </button>
          <button type="button" class="catalog-toolbar__button catalog-toolbar__button--primary" (click)="openNewProductPopup()">
            + Новый товар
          </button>
        </div>
      </div>
    </header>

    <div class="catalog-card__body" #catalogCardBody>
      <div class="error-message" *ngIf="loadErrorMessage() as errorMessage">
        {{ errorMessage }}
      </div>

      <ng-container *ngIf="catalogData as catalogData">
        <ng-container *ngIf="catalogData.length; else emptyCatalog">
          <section *ngIf="activeTab==='info'" class="catalog-tab">
            <ng-container *ngIf="infoPage() as page">
              <div class="catalog-table__container" #infoTableContainer>
                <table class="catalog-table">
        <thead #infoTableHeader>
          <tr>
            <th
              scope="col"
              class="sortable name-col"
              [class.sortable--active]="isSorted('info', 0)"
              [attr.data-direction]="getSortDirection('info', 0)"
              [attr.aria-sort]="getAriaSort('info', 0)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 0)">
                <span class="catalog-table__sort-label">Название</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable type-col"
              [class.sortable--active]="isSorted('info', 1)"
              [attr.data-direction]="getSortDirection('info', 1)"
              [attr.aria-sort]="getAriaSort('info', 1)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 1)">
                <span class="catalog-table__sort-label">Тип</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable code-col"
              [class.sortable--active]="isSorted('info', 2)"
              [attr.data-direction]="getSortDirection('info', 2)"
              [attr.aria-sort]="getAriaSort('info', 2)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 2)">
                <span class="catalog-table__sort-label">Код</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable category-col"
              [class.sortable--active]="isSorted('info', 3)"
              [attr.data-direction]="getSortDirection('info', 3)"
              [attr.aria-sort]="getAriaSort('info', 3)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 3)">
                <span class="catalog-table__sort-label">Категория</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable uom-col"
              [class.sortable--active]="isSorted('info', 4)"
              [attr.data-direction]="getSortDirection('info', 4)"
              [attr.aria-sort]="getAriaSort('info', 4)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 4)">
                <span class="catalog-table__sort-label">Ед. изм.</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable writeoff-col"
              [class.sortable--active]="isSorted('info', 5)"
              [attr.data-direction]="getSortDirection('info', 5)"
              [attr.aria-sort]="getAriaSort('info', 5)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 5)">
                <span class="catalog-table__sort-label">Метод списания</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable allergens-col"
              [class.sortable--active]="isSorted('info', 6)"
              [attr.data-direction]="getSortDirection('info', 6)"
              [attr.aria-sort]="getAriaSort('info', 6)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 6)">
                <span class="catalog-table__sort-label">Аллергены</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable flags-col"
              [class.sortable--active]="isSorted('info', 7)"
              [attr.data-direction]="getSortDirection('info', 7)"
              [attr.aria-sort]="getAriaSort('info', 7)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 7)">
                <span class="catalog-table__sort-label">Флаги</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of page.items" #infoRow>
            <td class="name-col">{{ item.name }}</td>
            <td class="type-col">{{ item.type }}</td>
            <td class="code-col">{{ item.code }}</td>
            <td class="category-col">{{ item.category }}</td>
            <td class="uom-col">{{ item.unit }}</td>
            <td class="writeoff-col">{{ item.writeoffMethod }}</td>
            <td class="allergens-col">{{ item.allergens }}</td>
            <td class="flags-col flags-cell">
              <div class="flags-list" *ngIf="item.flags?.length; else emptyFlags">
                <span
                  *ngFor="let flag of item.flags | slice:0:maxShown"
                  class="flag"
                  [ngClass]="'flag--' + (flag.code || 'default')"
                  [title]="resolveFlagFull(flag)"
                >
                  <i class="dot" aria-hidden="true"></i>
                  {{ resolveFlagShort(flag) }}
                </span>

                <span
                  *ngIf="item.flags.length > maxShown"
                  class="flag more"
                  [title]="getHiddenFlagsTooltip(item)"
                >
                  +{{ item.flags.length - maxShown }}
                </span>
              </div>

              <ng-template #emptyFlags><span class="muted">&mdash;</span></ng-template>
            </td>
          </tr>
        </tbody>
                </table>
              </div>
              <footer
                class="catalog-pagination"
                aria-label="Пагинация каталога — основная информация"
                #infoPagination
              >
                <div class="catalog-pagination__summary">
                  Показано {{ page.items.length }} из {{ page.totalItems }} позиций · Страница {{ page.page }} из
                  {{ page.totalPages }}
                </div>
                <div class="catalog-pagination__actions">
                  <button
                    type="button"
                    class="catalog-pagination__button"
                    (click)="prevPage('info')"
                    [disabled]="!canPrev('info')"
                  >
                    Назад
                  </button>
                  <button
                    type="button"
                    class="catalog-pagination__button"
                    (click)="nextPage('info')"
                    [disabled]="!canNext('info')"
                  >
                    Далее
                  </button>
                </div>
              </footer>
            </ng-container>
          </section>

          <section *ngIf="activeTab==='logistics'" class="catalog-tab">
            <ng-container *ngIf="logisticsPage() as page">
              <div class="catalog-table__container" #logisticsTableContainer>
                <table class="catalog-table">
        <thead #logisticsTableHeader>
          <tr>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 0)"
              [attr.data-direction]="getSortDirection('logistics', 0)"
              [attr.aria-sort]="getAriaSort('logistics', 0)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 0)">
                <span class="catalog-table__sort-label">Поставщик</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 1)"
              [attr.data-direction]="getSortDirection('logistics', 1)"
              [attr.aria-sort]="getAriaSort('logistics', 1)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 1)">
                <span class="catalog-table__sort-label">Оценочная себестоимость</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 2)"
              [attr.data-direction]="getSortDirection('logistics', 2)"
              [attr.aria-sort]="getAriaSort('logistics', 2)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 2)">
                <span class="catalog-table__sort-label">Ставка НДС</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 3)"
              [attr.data-direction]="getSortDirection('logistics', 3)"
              [attr.aria-sort]="getAriaSort('logistics', 3)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 3)">
                <span class="catalog-table__sort-label">Цена за ед.</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 4)"
              [attr.data-direction]="getSortDirection('logistics', 4)"
              [attr.aria-sort]="getAriaSort('logistics', 4)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 4)">
                <span class="catalog-table__sort-label">Цена продажи</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 5)"
              [attr.data-direction]="getSortDirection('logistics', 5)"
              [attr.aria-sort]="getAriaSort('logistics', 5)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 5)">
                <span class="catalog-table__sort-label">Код ТН ВЭД</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 6)"
              [attr.data-direction]="getSortDirection('logistics', 6)"
              [attr.aria-sort]="getAriaSort('logistics', 6)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 6)">
                <span class="catalog-table__sort-label">Маркируемый</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of page.items" #logisticsRow>
            <td>{{ item.supplier }}</td>
            <td>{{ item.costEstimate }}</td>
            <td>{{ item.taxRate }}</td>
            <td>{{ item.unitPrice }}</td>
            <td>{{ item.salePrice }}</td>
            <td>{{ item.tnved }}</td>
            <td>
              <span
                class="boolean-pill"
                [class.boolean-pill--positive]="item.isMarked === true"
                [class.boolean-pill--negative]="item.isMarked === false"
                [class.boolean-pill--unknown]="item.isMarked == null"
              >
                {{ item.isMarked | booleanLabel }}
              </span>
            </td>
          </tr>
        </tbody>
                </table>
              </div>
              <footer
                class="catalog-pagination"
                aria-label="Пагинация каталога — закупка и логистика"
                #logisticsPagination
              >
                <div class="catalog-pagination__summary">
                  Показано {{ page.items.length }} из {{ page.totalItems }} позиций · Страница {{ page.page }} из
                  {{ page.totalPages }}
                </div>
                <div class="catalog-pagination__actions">
                  <button
                    type="button"
                    class="catalog-pagination__button"
                    (click)="prevPage('logistics')"
                    [disabled]="!canPrev('logistics')"
                  >
                    Назад
                  </button>
                  <button
                    type="button"
                    class="catalog-pagination__button"
                    (click)="nextPage('logistics')"
                    [disabled]="!canNext('logistics')"
                  >
                    Далее
                  </button>
                </div>
              </footer>
            </ng-container>
          </section>
        </ng-container>
      </ng-container>

      <ng-template #emptyCatalog>
        <div class="catalog-empty">
          <app-empty
            class="mt-6 block"
            title="Каталог пока пуст"
            subtitle="Добавьте первый продукт, чтобы начать работу с каталогом."
          ></app-empty>
          <button type="button" class="catalog-empty__action" (click)="openNewProductPopup()">
            + Новый товар
          </button>
        </div>
      </ng-template>
    </div>
  </section>
</div>

<app-catalog-new-product-popup
  *ngIf="isNewProductPopupVisible()"
  [errorMessage]="creationErrorMessage()"
  (cancel)="closeNewProductPopup()"
  (save)="addProduct($event)"
></app-catalog-new-product-popup>
