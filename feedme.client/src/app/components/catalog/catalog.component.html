<div class="catalog-page">
  <div
    class="catalog-tabs"
    role="tablist"
    aria-label="Каталог"
  >
    <button
      type="button"
      class="catalog-tabs__button"
      role="tab"
      (click)="activeTab = 'info'"
      [class.catalog-tabs__button--active]="activeTab === 'info'"
      [attr.aria-selected]="activeTab === 'info'"
    >
      Основная информация
    </button>
    <button
      type="button"
      class="catalog-tabs__button"
      role="tab"
      (click)="activeTab = 'logistics'"
      [class.catalog-tabs__button--active]="activeTab === 'logistics'"
      [attr.aria-selected]="activeTab === 'logistics'"
    >
      Закупка и логистика
    </button>
  </div>

  <section class="catalog-card" #catalogCard>
    <div class="catalog-card__header">
      <div class="catalog-search">
        <input
          #searchInput
          type="search"
          class="catalog-search__input"
          placeholder="Поиск по номеру, SKU или названию"
          [value]="searchQuery()"
          (input)="onSearch(searchInput.value)"
          aria-label="Поиск по номеру, SKU или названию"
        />
      </div>
      <div class="catalog-actions">
        <button type="button" class="catalog-actions__button catalog-actions__button--ghost" (click)="onResetFilters()">
          Сброс
        </button>
        <button type="button" class="catalog-actions__button catalog-actions__button--ghost" (click)="onImportClick()">
          Импорт
        </button>
        <button type="button" class="catalog-actions__button catalog-actions__button--ghost" (click)="onExportClick()">
          Экспорт
        </button>
        <button
          type="button"
          class="catalog-actions__button catalog-actions__button--primary"
          (click)="openNewProductPopup()"
        >
          + Новый товар
        </button>
      </div>
    </div>

    <div class="catalog-card__body" #catalogCardBody>
      <div class="catalog-error" *ngIf="loadErrorMessage() as errorMessage">
        {{ errorMessage }}
      </div>

      <ng-container *ngIf="catalogData as catalogData">
        <ng-container *ngIf="catalogData.length; else emptyCatalog">
          <section *ngIf="activeTab === 'info'" class="catalog-tab">
            <ng-container *ngIf="infoPage() as page">
              <div class="catalog-table__container" #infoTableContainer>
                <table class="catalog-table">
                  <thead #infoTableHeader class="catalog-table__head">
                    <tr>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable name-col"
                        [class.sortable--active]="isSorted('info', 0)"
                        [attr.data-direction]="getSortDirection('info', 0)"
                        [attr.aria-sort]="getAriaSort('info', 0)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('info', 0)">
                          <span class="catalog-table__label catalog-table__label--accent">Название</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable type-col"
                        [class.sortable--active]="isSorted('info', 1)"
                        [attr.data-direction]="getSortDirection('info', 1)"
                        [attr.aria-sort]="getAriaSort('info', 1)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('info', 1)">
                          <span class="catalog-table__label">Тип</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable code-col"
                        [class.sortable--active]="isSorted('info', 2)"
                        [attr.data-direction]="getSortDirection('info', 2)"
                        [attr.aria-sort]="getAriaSort('info', 2)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('info', 2)">
                          <span class="catalog-table__label">SKU</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable category-col"
                        [class.sortable--active]="isSorted('info', 3)"
                        [attr.data-direction]="getSortDirection('info', 3)"
                        [attr.aria-sort]="getAriaSort('info', 3)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('info', 3)">
                          <span class="catalog-table__label">Категория</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable uom-col"
                        [class.sortable--active]="isSorted('info', 4)"
                        [attr.data-direction]="getSortDirection('info', 4)"
                        [attr.aria-sort]="getAriaSort('info', 4)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('info', 4)">
                          <span class="catalog-table__label">Ед. изм.</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable writeoff-col"
                        [class.sortable--active]="isSorted('info', 5)"
                        [attr.data-direction]="getSortDirection('info', 5)"
                        [attr.aria-sort]="getAriaSort('info', 5)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('info', 5)">
                          <span class="catalog-table__label">Списание</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable allergens-col"
                        [class.sortable--active]="isSorted('info', 6)"
                        [attr.data-direction]="getSortDirection('info', 6)"
                        [attr.aria-sort]="getAriaSort('info', 6)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('info', 6)">
                          <span class="catalog-table__label">Аллергены</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable flags-col"
                        [class.sortable--active]="isSorted('info', 7)"
                        [attr.data-direction]="getSortDirection('info', 7)"
                        [attr.aria-sort]="getAriaSort('info', 7)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('info', 7)">
                          <span class="catalog-table__label">Флаги</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of page.items" class="catalog-table__row" #infoRow>
                      <td class="catalog-table__cell name-col catalog-table__cell--accent">
                        <span class="catalog-table__value truncate" [title]="item.name">{{ item.name }}</span>
                      </td>
                      <td class="catalog-table__cell type-col">
                        <span class="catalog-table__value truncate" [title]="item.type">{{ item.type }}</span>
                      </td>
                      <td class="catalog-table__cell code-col">
                        <span class="catalog-table__value truncate" [title]="item.code">{{ item.code }}</span>
                      </td>
                      <td class="catalog-table__cell category-col">
                        <span class="catalog-table__value truncate" [title]="item.category">{{ item.category }}</span>
                      </td>
                      <td class="catalog-table__cell uom-col">
                        <span class="catalog-table__value truncate" [title]="item.unit">{{ item.unit }}</span>
                      </td>
                      <td class="catalog-table__cell writeoff-col">
                        <span class="catalog-table__value truncate" [title]="item.writeoffMethod">
                          {{ item.writeoffMethod }}
                        </span>
                      </td>
                      <td class="catalog-table__cell allergens-col">
                        <span class="catalog-table__value truncate" [title]="item.allergens">{{ item.allergens }}</span>
                      </td>
                      <td class="catalog-table__cell flags-col">
                        <app-catalog-flag-list
                          *ngIf="item.flags?.length; else emptyFlags"
                          [flags]="item.flags"
                        ></app-catalog-flag-list>
                        <ng-template #emptyFlags>
                          <span class="catalog-table__muted">&mdash;</span>
                        </ng-template>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <footer
                class="catalog-pagination"
                aria-label="Навигация по странице основной информации"
                #infoPagination
              >
                <div class="catalog-pagination__summary">
                  <span class="catalog-pagination__summary-text">
                    Показано {{ page.items.length }} из {{ page.totalItems }} позиций · Страница {{ page.page }} из
                    {{ page.totalPages }}
                  </span>
                </div>
                <div class="catalog-pagination__actions">
                  <button
                    type="button"
                    class="catalog-pagination__button"
                    (click)="prevPage('info')"
                    [disabled]="!canPrev('info')"
                  >
                    Назад
                  </button>
                  <button
                    type="button"
                    class="catalog-pagination__button"
                    (click)="nextPage('info')"
                    [disabled]="!canNext('info')"
                  >
                    Далее
                  </button>
                </div>
              </footer>
            </ng-container>
          </section>

          <section *ngIf="activeTab === 'logistics'" class="catalog-tab">
            <ng-container *ngIf="logisticsPage() as page">
              <div class="catalog-table__container" #logisticsTableContainer>
                <table class="catalog-table">
                  <thead #logisticsTableHeader class="catalog-table__head">
                    <tr>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable"
                        [class.sortable--active]="isSorted('logistics', 0)"
                        [attr.data-direction]="getSortDirection('logistics', 0)"
                        [attr.aria-sort]="getAriaSort('logistics', 0)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 0)">
                          <span class="catalog-table__label">Поставщик</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable"
                        [class.sortable--active]="isSorted('logistics', 1)"
                        [attr.data-direction]="getSortDirection('logistics', 1)"
                        [attr.aria-sort]="getAriaSort('logistics', 1)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 1)">
                          <span class="catalog-table__label">Себестоимость</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable"
                        [class.sortable--active]="isSorted('logistics', 2)"
                        [attr.data-direction]="getSortDirection('logistics', 2)"
                        [attr.aria-sort]="getAriaSort('logistics', 2)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 2)">
                          <span class="catalog-table__label">НДС</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable"
                        [class.sortable--active]="isSorted('logistics', 3)"
                        [attr.data-direction]="getSortDirection('logistics', 3)"
                        [attr.aria-sort]="getAriaSort('logistics', 3)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 3)">
                          <span class="catalog-table__label">Цена закупки</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable"
                        [class.sortable--active]="isSorted('logistics', 4)"
                        [attr.data-direction]="getSortDirection('logistics', 4)"
                        [attr.aria-sort]="getAriaSort('logistics', 4)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 4)">
                          <span class="catalog-table__label">Цена продажи</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable"
                        [class.sortable--active]="isSorted('logistics', 5)"
                        [attr.data-direction]="getSortDirection('logistics', 5)"
                        [attr.aria-sort]="getAriaSort('logistics', 5)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 5)">
                          <span class="catalog-table__label">Код ТН ВЭД</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th
                        scope="col"
                        class="catalog-table__heading sortable"
                        [class.sortable--active]="isSorted('logistics', 6)"
                        [attr.data-direction]="getSortDirection('logistics', 6)"
                        [attr.aria-sort]="getAriaSort('logistics', 6)"
                      >
                        <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 6)">
                          <span class="catalog-table__label">Маркировка</span>
                          <span class="catalog-table__sort-icon" aria-hidden="true"></span>
                        </button>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of page.items" class="catalog-table__row" #logisticsRow>
                      <td class="catalog-table__cell">
                        <span class="catalog-table__value truncate" [title]="item.supplier">{{ item.supplier }}</span>
                      </td>
                      <td class="catalog-table__cell">
                        <span class="catalog-table__value truncate" [title]="item.costEstimate">
                          {{ item.costEstimate }}
                        </span>
                      </td>
                      <td class="catalog-table__cell">
                        <span class="catalog-table__value truncate" [title]="item.taxRate">{{ item.taxRate }}</span>
                      </td>
                      <td class="catalog-table__cell">
                        <span class="catalog-table__value truncate" [title]="item.unitPrice">{{ item.unitPrice }}</span>
                      </td>
                      <td class="catalog-table__cell">
                        <span class="catalog-table__value truncate" [title]="item.salePrice">{{ item.salePrice }}</span>
                      </td>
                      <td class="catalog-table__cell">
                        <span class="catalog-table__value truncate" [title]="item.tnved">{{ item.tnved }}</span>
                      </td>
                      <td class="catalog-table__cell">
                        <span
                          class="catalog-status"
                          [class.catalog-status--positive]="item.isMarked === true"
                          [class.catalog-status--negative]="item.isMarked === false"
                          [class.catalog-status--unknown]="item.isMarked == null"
                        >
                          {{ item.isMarked | booleanLabel }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <footer
                class="catalog-pagination"
                aria-label="Навигация по странице логистики"
                #logisticsPagination
              >
                <div class="catalog-pagination__summary">
                  <span class="catalog-pagination__summary-text">
                    Показано {{ page.items.length }} из {{ page.totalItems }} позиций · Страница {{ page.page }} из
                    {{ page.totalPages }}
                  </span>
                </div>
                <div class="catalog-pagination__actions">
                  <button
                    type="button"
                    class="catalog-pagination__button"
                    (click)="prevPage('logistics')"
                    [disabled]="!canPrev('logistics')"
                  >
                    Назад
                  </button>
                  <button
                    type="button"
                    class="catalog-pagination__button"
                    (click)="nextPage('logistics')"
                    [disabled]="!canNext('logistics')"
                  >
                    Далее
                  </button>
                </div>
              </footer>
            </ng-container>
          </section>
        </ng-container>
      </ng-container>

      <ng-template #emptyCatalog>
        <div class="catalog-empty">
          <app-empty
            class="catalog-empty__state"
            title="Каталог пока пуст"
            subtitle="Используйте поиск или добавьте новый товар, чтобы наполнить каталог."
          ></app-empty>
          <button type="button" class="catalog-empty__action" (click)="openNewProductPopup()">
            + Новый товар
          </button>
        </div>
      </ng-template>
    </div>
  </section>
</div>

<app-catalog-new-product-popup
  *ngIf="isNewProductPopupVisible()"
  [errorMessage]="creationErrorMessage()"
  (cancel)="closeNewProductPopup()"
  (save)="addProduct($event)"
></app-catalog-new-product-popup>
