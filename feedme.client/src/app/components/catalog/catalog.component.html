<div class="catalog-header">
  <div class="tabs" role="tablist" aria-label="Каталог">
    <button
      type="button"
      class="tab"
      role="tab"
      (click)="activeTab='info'"
      [class.active]="activeTab==='info'"
      [attr.aria-selected]="activeTab === 'info'"
    >
      Основная информация
    </button>
    <button
      type="button"
      class="tab"
      role="tab"
      (click)="activeTab='logistics'"
      [class.active]="activeTab==='logistics'"
      [attr.aria-selected]="activeTab === 'logistics'"
    >
      Закупка и логистика
    </button>
  </div>
  <button type="button" class="catalog-header__action" (click)="openNewProductPopup()">
    + Новый товар
  </button>
</div>
<div class="error-message" *ngIf="loadErrorMessage() as errorMessage">{{ errorMessage }}</div>

<ng-container *ngIf="catalogData as catalogData">
  <ng-container *ngIf="catalogData.length; else emptyCatalog">
    <div *ngIf="activeTab==='info'">
      <table class="catalog-table">
        <thead>
          <tr>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('info', 0)"
              (keydown)="onSortKey('info', 0, $event)"
              [class.sortable--active]="isSorted('info', 0)"
              [attr.data-direction]="getSortDirection('info', 0)"
              [attr.aria-sort]="getAriaSort('info', 0)"
            >
              <span>Название</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('info', 1)"
              (keydown)="onSortKey('info', 1, $event)"
              [class.sortable--active]="isSorted('info', 1)"
              [attr.data-direction]="getSortDirection('info', 1)"
              [attr.aria-sort]="getAriaSort('info', 1)"
            >
              <span>Тип</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('info', 2)"
              (keydown)="onSortKey('info', 2, $event)"
              [class.sortable--active]="isSorted('info', 2)"
              [attr.data-direction]="getSortDirection('info', 2)"
              [attr.aria-sort]="getAriaSort('info', 2)"
            >
              <span>Код</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('info', 3)"
              (keydown)="onSortKey('info', 3, $event)"
              [class.sortable--active]="isSorted('info', 3)"
              [attr.data-direction]="getSortDirection('info', 3)"
              [attr.aria-sort]="getAriaSort('info', 3)"
            >
              <span>Категория</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('info', 4)"
              (keydown)="onSortKey('info', 4, $event)"
              [class.sortable--active]="isSorted('info', 4)"
              [attr.data-direction]="getSortDirection('info', 4)"
              [attr.aria-sort]="getAriaSort('info', 4)"
            >
              <span>Ед.изм.</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('info', 5)"
              (keydown)="onSortKey('info', 5, $event)"
              [class.sortable--active]="isSorted('info', 5)"
              [attr.data-direction]="getSortDirection('info', 5)"
              [attr.aria-sort]="getAriaSort('info', 5)"
            >
              <span>Метод списания</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('info', 6)"
              (keydown)="onSortKey('info', 6, $event)"
              [class.sortable--active]="isSorted('info', 6)"
              [attr.data-direction]="getSortDirection('info', 6)"
              [attr.aria-sort]="getAriaSort('info', 6)"
            >
              <span>Аллергены</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('info', 7)"
              (keydown)="onSortKey('info', 7, $event)"
              [class.sortable--active]="isSorted('info', 7)"
              [attr.data-direction]="getSortDirection('info', 7)"
              [attr.aria-sort]="getAriaSort('info', 7)"
            >
              <span>Флаги</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of sortedInfoItems()">
            <td>{{ item.name }}</td>
            <td>{{ item.type }}</td>
            <td>{{ item.code }}</td>
            <td>{{ item.category }}</td>
            <td>{{ item.unit }}</td>
            <td>{{ item.writeoffMethod }}</td>
            <td>{{ item.allergens }}</td>
            <td>
              <div>Требует фасовки: {{ item.packagingRequired | booleanLabel }}</div>
              <div>Портится после вскрытия: {{ item.spoilsAfterOpening | booleanLabel }}</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="activeTab==='logistics'">
      <table class="catalog-table">
        <thead>
          <tr>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('logistics', 0)"
              (keydown)="onSortKey('logistics', 0, $event)"
              [class.sortable--active]="isSorted('logistics', 0)"
              [attr.data-direction]="getSortDirection('logistics', 0)"
              [attr.aria-sort]="getAriaSort('logistics', 0)"
            >
              <span>Поставщик</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('logistics', 1)"
              (keydown)="onSortKey('logistics', 1, $event)"
              [class.sortable--active]="isSorted('logistics', 1)"
              [attr.data-direction]="getSortDirection('logistics', 1)"
              [attr.aria-sort]="getAriaSort('logistics', 1)"
            >
              <span>Оценочная себестоимость</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('logistics', 2)"
              (keydown)="onSortKey('logistics', 2, $event)"
              [class.sortable--active]="isSorted('logistics', 2)"
              [attr.data-direction]="getSortDirection('logistics', 2)"
              [attr.aria-sort]="getAriaSort('logistics', 2)"
            >
              <span>Ставка НДС</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('logistics', 3)"
              (keydown)="onSortKey('logistics', 3, $event)"
              [class.sortable--active]="isSorted('logistics', 3)"
              [attr.data-direction]="getSortDirection('logistics', 3)"
              [attr.aria-sort]="getAriaSort('logistics', 3)"
            >
              <span>Цена за ед.</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('logistics', 4)"
              (keydown)="onSortKey('logistics', 4, $event)"
              [class.sortable--active]="isSorted('logistics', 4)"
              [attr.data-direction]="getSortDirection('logistics', 4)"
              [attr.aria-sort]="getAriaSort('logistics', 4)"
            >
              <span>Цена продажи</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('logistics', 5)"
              (keydown)="onSortKey('logistics', 5, $event)"
              [class.sortable--active]="isSorted('logistics', 5)"
              [attr.data-direction]="getSortDirection('logistics', 5)"
              [attr.aria-sort]="getAriaSort('logistics', 5)"
            >
              <span>Код ТН ВЭД</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
            <th
              scope="col"
              class="sortable"
              tabindex="0"
              (click)="onSort('logistics', 6)"
              (keydown)="onSortKey('logistics', 6, $event)"
              [class.sortable--active]="isSorted('logistics', 6)"
              [attr.data-direction]="getSortDirection('logistics', 6)"
              [attr.aria-sort]="getAriaSort('logistics', 6)"
            >
              <span>Маркируемый</span>
              <span class="sort" aria-hidden="true"></span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of sortedLogisticsItems()">
            <td>{{ item.supplier }}</td>
            <td>{{ item.costEstimate }}</td>
            <td>{{ item.taxRate }}</td>
            <td>{{ item.unitPrice }}</td>
            <td>{{ item.salePrice }}</td>
            <td>{{ item.tnved }}</td>
            <td>{{ item.isMarked }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</ng-container>

<ng-template #emptyCatalog>
  <div class="catalog-empty">
    <app-empty
      class="mt-6 block"
      title="Каталог пока пуст"
      subtitle="Добавьте первый продукт, чтобы начать работу с каталогом."
    ></app-empty>
    <button type="button" class="catalog-empty__action" (click)="openNewProductPopup()">
      + Новый товар
    </button>
  </div>
</ng-template>

<app-catalog-new-product-popup
  *ngIf="isNewProductPopupVisible()"
  [errorMessage]="creationErrorMessage()"
  (cancel)="closeNewProductPopup()"
  (save)="addProduct($event)"
></app-catalog-new-product-popup>
