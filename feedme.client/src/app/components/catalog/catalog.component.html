<div class="catalog-header">
  <div class="tabs" role="tablist" aria-label="Каталог">
    <button
      type="button"
      class="tab"
      role="tab"
      (click)="activeTab='info'"
      [class.active]="activeTab==='info'"
      [attr.aria-selected]="activeTab === 'info'"
    >
      Основная информация
    </button>
    <button
      type="button"
      class="tab"
      role="tab"
      (click)="activeTab='logistics'"
      [class.active]="activeTab==='logistics'"
      [attr.aria-selected]="activeTab === 'logistics'"
    >
      Закупка и логистика
    </button>
  </div>
  <button type="button" class="catalog-header__action" (click)="openNewProductPopup()">
    + Новый товар
  </button>
</div>
<div class="error-message" *ngIf="loadErrorMessage() as errorMessage">{{ errorMessage }}</div>

<ng-container *ngIf="catalogData as catalogData">
  <ng-container *ngIf="catalogData.length; else emptyCatalog">
    <div *ngIf="activeTab==='info'" class="catalog-table__container">
      <table class="catalog-table">
        <thead>
          <tr>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('info', 0)"
              [attr.data-direction]="getSortDirection('info', 0)"
              [attr.aria-sort]="getAriaSort('info', 0)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 0)">
                <span class="catalog-table__sort-label">Название</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('info', 1)"
              [attr.data-direction]="getSortDirection('info', 1)"
              [attr.aria-sort]="getAriaSort('info', 1)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 1)">
                <span class="catalog-table__sort-label">Тип</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('info', 2)"
              [attr.data-direction]="getSortDirection('info', 2)"
              [attr.aria-sort]="getAriaSort('info', 2)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 2)">
                <span class="catalog-table__sort-label">Код</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('info', 3)"
              [attr.data-direction]="getSortDirection('info', 3)"
              [attr.aria-sort]="getAriaSort('info', 3)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 3)">
                <span class="catalog-table__sort-label">Категория</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('info', 4)"
              [attr.data-direction]="getSortDirection('info', 4)"
              [attr.aria-sort]="getAriaSort('info', 4)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 4)">
                <span class="catalog-table__sort-label">Ед. изм.</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('info', 5)"
              [attr.data-direction]="getSortDirection('info', 5)"
              [attr.aria-sort]="getAriaSort('info', 5)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 5)">
                <span class="catalog-table__sort-label">Метод списания</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('info', 6)"
              [attr.data-direction]="getSortDirection('info', 6)"
              [attr.aria-sort]="getAriaSort('info', 6)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 6)">
                <span class="catalog-table__sort-label">Аллергены</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('info', 7)"
              [attr.data-direction]="getSortDirection('info', 7)"
              [attr.aria-sort]="getAriaSort('info', 7)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('info', 7)">
                <span class="catalog-table__sort-label">Флаги</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of sortedInfoItems()">
            <td>{{ item.name }}</td>
            <td>{{ item.type }}</td>
            <td>{{ item.code }}</td>
            <td>{{ item.category }}</td>
            <td>{{ item.unit }}</td>
            <td>{{ item.writeoffMethod }}</td>
            <td>{{ item.allergens }}</td>
            <td>
              <div class="boolean-flag-row">
                <span class="boolean-flag-row__label">Требует фасовки</span>
                <span
                  class="boolean-pill"
                  [class.boolean-pill--positive]="item.packagingRequired === true"
                  [class.boolean-pill--negative]="item.packagingRequired === false"
                  [class.boolean-pill--unknown]="item.packagingRequired == null"
                >
                  {{ item.packagingRequired | booleanLabel }}
                </span>
              </div>
              <div class="boolean-flag-row">
                <span class="boolean-flag-row__label">Портится после вскрытия</span>
                <span
                  class="boolean-pill"
                  [class.boolean-pill--positive]="item.spoilsAfterOpening === true"
                  [class.boolean-pill--negative]="item.spoilsAfterOpening === false"
                  [class.boolean-pill--unknown]="item.spoilsAfterOpening == null"
                >
                  {{ item.spoilsAfterOpening | booleanLabel }}
                </span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="activeTab==='logistics'" class="catalog-table__container">
      <table class="catalog-table">
        <thead>
          <tr>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 0)"
              [attr.data-direction]="getSortDirection('logistics', 0)"
              [attr.aria-sort]="getAriaSort('logistics', 0)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 0)">
                <span class="catalog-table__sort-label">Поставщик</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 1)"
              [attr.data-direction]="getSortDirection('logistics', 1)"
              [attr.aria-sort]="getAriaSort('logistics', 1)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 1)">
                <span class="catalog-table__sort-label">Оценочная себестоимость</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 2)"
              [attr.data-direction]="getSortDirection('logistics', 2)"
              [attr.aria-sort]="getAriaSort('logistics', 2)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 2)">
                <span class="catalog-table__sort-label">Ставка НДС</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 3)"
              [attr.data-direction]="getSortDirection('logistics', 3)"
              [attr.aria-sort]="getAriaSort('logistics', 3)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 3)">
                <span class="catalog-table__sort-label">Цена за ед.</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 4)"
              [attr.data-direction]="getSortDirection('logistics', 4)"
              [attr.aria-sort]="getAriaSort('logistics', 4)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 4)">
                <span class="catalog-table__sort-label">Цена продажи</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 5)"
              [attr.data-direction]="getSortDirection('logistics', 5)"
              [attr.aria-sort]="getAriaSort('logistics', 5)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 5)">
                <span class="catalog-table__sort-label">Код ТН ВЭД</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
            <th
              scope="col"
              class="sortable"
              [class.sortable--active]="isSorted('logistics', 6)"
              [attr.data-direction]="getSortDirection('logistics', 6)"
              [attr.aria-sort]="getAriaSort('logistics', 6)"
            >
              <button type="button" class="catalog-table__sort" (click)="onSort('logistics', 6)">
                <span class="catalog-table__sort-label">Маркируемый</span>
                <span class="catalog-table__sort-icon" aria-hidden="true"></span>
              </button>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of sortedLogisticsItems()">
            <td>{{ item.supplier }}</td>
            <td>{{ item.costEstimate }}</td>
            <td>{{ item.taxRate }}</td>
            <td>{{ item.unitPrice }}</td>
            <td>{{ item.salePrice }}</td>
            <td>{{ item.tnved }}</td>
            <td>
              <span
                class="boolean-pill"
                [class.boolean-pill--positive]="item.isMarked === true"
                [class.boolean-pill--negative]="item.isMarked === false"
                [class.boolean-pill--unknown]="item.isMarked == null"
              >
                {{ item.isMarked | booleanLabel }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</ng-container>

<ng-template #emptyCatalog>
  <div class="catalog-empty">
    <app-empty
      class="mt-6 block"
      title="Каталог пока пуст"
      subtitle="Добавьте первый продукт, чтобы начать работу с каталогом."
    ></app-empty>
    <button type="button" class="catalog-empty__action" (click)="openNewProductPopup()">
      + Новый товар
    </button>
  </div>
</ng-template>

<app-catalog-new-product-popup
  *ngIf="isNewProductPopupVisible()"
  [errorMessage]="creationErrorMessage()"
  (cancel)="closeNewProductPopup()"
  (save)="addProduct($event)"
></app-catalog-new-product-popup>
