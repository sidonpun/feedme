<div class="popup-backdrop">
  <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="new-product-title">
    <div class="popup-header">
      <h2 id="new-product-title" class="popup-title">Новый товар</h2>
      <button class="close-btn" type="button" (click)="close()" aria-label="Закрыть окно">
        ×
      </button>
    </div>

    <p class="error-message" *ngIf="errorMessage">{{ errorMessage }}</p>

    <form class="form" [formGroup]="form" (ngSubmit)="onSubmit()">
      <section class="section">
        <h3 class="section-title">Основная информация</h3>
        <div class="form-grid">
          <div class="input-container">
            <label for="new-product-name">Название товара</label>
            <input id="new-product-name" formControlName="name" autocomplete="off" placeholder="Например, Курица гриль" />
          </div>
          <div class="input-container">
            <label for="new-product-type">Тип номенклатуры</label>
            <select id="new-product-type" formControlName="type">
              <option *ngFor="let t of types" [value]="t">{{ t }}</option>
            </select>
          </div>
          <div class="input-container">
            <label for="new-product-code">Номенклатурный код</label>
            <input id="new-product-code" formControlName="code" autocomplete="off" placeholder="Например, MEAT-003" />
          </div>
          <div class="input-container">
            <label for="new-product-category">Категория</label>
            <input id="new-product-category" formControlName="category" autocomplete="off" placeholder="Например, Мясные заготовки" />
          </div>
          <div class="input-container">
            <label for="new-product-unit">Единица измерения (базовая)</label>
            <select id="new-product-unit" formControlName="unit">
              <option *ngFor="let u of units" [value]="u">{{ u }}</option>
            </select>
          </div>
          <div class="flags-field">
            <label class="fm-label">Флаги товара</label>
            <div class="fm-flags" #flagsContainer>
              <button
                type="button"
                class="fm-flags__control"
                [attr.aria-expanded]="flagsOpen"
                (click)="openFlagsDropdown($event)"
              >
                <ng-container *ngIf="selectedFlags?.length; else flagsEmpty">
                  <div class="fm-flags__chips">
                    <ng-container *ngFor="let code of selectedFlags | slice:0:maxVisibleFlags">
                      <ng-container *ngFor="let flag of flagOptions">
                        <span
                          *ngIf="flag.code === code"
                          class="flag"
                          [ngClass]="'flag--' + flag.code"
                          [title]="flag.full"
                        >
                          <i class="dot"></i>{{ flag.short }}
                        </span>
                      </ng-container>
                    </ng-container>
                    <span *ngIf="selectedFlags.length > maxVisibleFlags" class="flag more">
                      +{{ selectedFlags.length - maxVisibleFlags }}
                    </span>
                  </div>
                </ng-container>
                <ng-template #flagsEmpty>
                  <span class="muted">Выберите флаги (0..все)</span>
                </ng-template>
                <span class="caret">v</span>
              </button>

              <div
                class="fm-flags__menu"
                *ngIf="flagsOpen"
                (mousedown)="$event.preventDefault()"
              >
                <label
                  class="fm-flags__item"
                  *ngFor="let flag of flagOptions"
                  [title]="flag.full"
                  (click)="toggleFlag(flag.code)"
                >
                  <input
                    type="checkbox"
                    class="fm-checkbox"
                    [checked]="selectedFlags?.includes(flag.code)"
                    (click)="$event.stopPropagation()"
                  />
                  <span class="flag" [ngClass]="'flag--' + flag.code">
                    <i class="dot"></i>{{ flag.short }}
                  </span>
                  <span class="label">{{ flag.full }}</span>
                </label>
              </div>
            </div>
          </div>
          <div class="input-container">
            <label for="new-product-writeoff">Метод списания</label>
            <select id="new-product-writeoff" formControlName="writeoffMethod">
              <option value="FIFO">FIFO</option>
              <option value="FEFO">FEFO</option>
              <option value="LIFO">LIFO</option>
            </select>
          </div>
          <div class="input-container">
            <label for="new-product-allergens">Аллергены</label>
            <input id="new-product-allergens" formControlName="allergens" autocomplete="off" placeholder="Например, молоко" />
          </div>
        </div>
      </section>

      <section class="section">
        <h3 class="section-title">Закупка и логистика</h3>
        <div class="form-grid">
          <div class="input-container">
            <label for="new-product-supplier">Поставщик (основной)</label>
            <input id="new-product-supplier" formControlName="supplier" autocomplete="off" placeholder="Например, ООО Кури Дурс" />
          </div>
          <div class="input-container">
            <label for="new-product-cost">Оценочная себестоимость</label>
            <input
              id="new-product-cost"
              type="number"
              formControlName="costEstimate"
              inputmode="decimal"
              placeholder="Например, 350"
            />
          </div>
          <div class="input-container">
            <label for="new-product-tax">Ставка НДС</label>
            <select id="new-product-tax" formControlName="taxRate">
              <option *ngFor="let rate of taxRates" [value]="rate">{{ rate }}</option>
            </select>
          </div>
          <div class="input-container">
            <label for="new-product-unit-price">Цена за единицу</label>
            <input
              id="new-product-unit-price"
              type="number"
              formControlName="unitPrice"
              inputmode="decimal"
              placeholder="Например, 420"
            />
          </div>
          <div class="input-container">
            <label for="new-product-sale-price">Цена продажи (опционально)</label>
            <input
              id="new-product-sale-price"
              type="number"
              formControlName="salePrice"
              inputmode="decimal"
              placeholder="Например, 520"
            />
          </div>
          <div class="input-container">
            <label for="new-product-tnved">Код ТН ВЭД</label>
            <input id="new-product-tnved" formControlName="tnved" autocomplete="off" placeholder="Например, 0207" />
          </div>
          <div class="checkbox-container">
            <label class="checkbox-label" for="new-product-marked">
              <input id="new-product-marked" type="checkbox" formControlName="isMarked" />
              Маркируемый товар
            </label>
          </div>
          <div class="checkbox-container">
            <label class="checkbox-label" for="new-product-alcohol">
              <input id="new-product-alcohol" type="checkbox" formControlName="isAlcohol" />
              Алкогольная продукция
            </label>
          </div>
        </div>
      </section>

      <section class="section" *ngIf="form.get('isAlcohol')?.value">
        <h3 class="section-title">Алкогольная продукция</h3>
        <div class="form-grid">
          <div class="input-container">
            <label for="new-product-alcohol-code">Код вида алкоголя</label>
            <input id="new-product-alcohol-code" formControlName="alcoholCode" autocomplete="off" />
          </div>
          <div class="input-container">
            <label for="new-product-alcohol-strength">Крепость (%)</label>
            <input
              id="new-product-alcohol-strength"
              type="number"
              formControlName="alcoholStrength"
              inputmode="decimal"
              placeholder="Например, 40"
            />
          </div>
          <div class="input-container">
            <label for="new-product-alcohol-volume">Объем тары, л</label>
            <input
              id="new-product-alcohol-volume"
              type="number"
              formControlName="alcoholVolume"
              inputmode="decimal"
              placeholder="Например, 0.75"
            />
          </div>
        </div>
      </section>

      <div class="popup-buttons">
        <button type="button" class="cancel-btn" (click)="close()">Отмена</button>
        <button type="submit" class="save-btn" [disabled]="form.invalid">Сохранить</button>
      </div>
    </form>
  </div>
</div>
